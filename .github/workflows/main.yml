name: 2.æ—¶å…‰æœºæ¬è¿ (çº¯å‡€ç‰ˆ - æ— åˆ é™¤)

on:
  schedule:
    - cron: '0 */12 * * *'  # æ¯å¤©è·‘ä¸¤æ¬¡
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘

jobs:
  time-machine-pure:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: æ‰§è¡Œæ’åºæ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” è·å–åˆ—è¡¨å¹¶è¿›è¡Œç‰ˆæœ¬å·æ’åº..."
          
          # 1. grep "^v": åªä¿ç•™ v å¼€å¤´çš„æ­£å¼ç‰ˆ (è¿‡æ»¤ Prerelease)
          # 2. sort -V: æŒ‰ç‰ˆæœ¬å·ä»å°åˆ°å¤§æ’åº (v2.9 -> v2.11)
          # è¿™æ ·è„šæœ¬ä¼šæŒ‰é¡ºåºå¤„ç†ï¼Œä¿è¯æ–°ç‰ˆæœ¬çš„æ—¶é—´æˆ³æ°¸è¿œæ™šäºæ—§ç‰ˆæœ¬
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' \
            | grep "^v" \
            | sort -V > tags.txt
          
          if [ ! -s tags.txt ]; then
            echo "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆç‰ˆæœ¬ï¼"
            exit 1
          fi
          
          # æå‰é”å®šç‰ˆæœ¬å·æœ€å¤§çš„é‚£ä¸ªï¼Œä½œä¸º Latest ç›®æ ‡
          LATEST_TARGET=$(tail -n 1 tags.txt)
          echo "ğŸ¯ æœ¬æ¬¡é”å®šçš„æœ€æ–°ç‰ˆæœ¬æ˜¯: $LATEST_TARGET"
          
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # --- æŸ¥é‡ (æ ¸å¿ƒå®‰å…¨æœºåˆ¶) ---
            # å¦‚æœç‰ˆæœ¬å·²å­˜åœ¨ï¼Œç›´æ¥è·³è¿‡ï¼Œç»ä¸è¦†ç›–æˆ–åˆ é™¤
            if gh release view $NEW_TAG > /dev/null 2>&1; then
              echo "[$CURRENT/$TOTAL] âœ… $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "----------------------------------------"
            echo "ğŸš€ [$CURRENT/$TOTAL] å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ¬è¿ä¸­: $TAG"
            
            # 1. æŠ“å–æ—¶é—´ (ä»…åšæ—¥å¿—å±•ç¤º)
            RAW_DATE=$(gh release view $TAG -R $SOURCE_REPO --json publishedAt -q .publishedAt 2>/dev/null) || true
            if [ -n "$RAW_DATE" ]; then
                NICE_DATE=$(date -d "$RAW_DATE" +'%Y-%m-%d %H:%M')
            else
                NICE_DATE="Unknown"
            fi
            
            # 2. å‡†å¤‡æ—¥å¿—
            gh release view $TAG -R $SOURCE_REPO --json body -q .body > logs.txt
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            cat logs.txt >> notes.md
            
            # 3. ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null || true
            
            # 4. ä¸Šä¼ 
            # å“ªæ€•è¿™é‡Œä¸åŠ  --latestï¼Œè„šæœ¬æœ€åä¸€æ­¥ä¹Ÿä¼šä¿®æ­£
            if [ "$(ls -A download_temp)" ]; then
               gh release create $NEW_TAG download_temp/* --title "CMFA: $TAG" -F notes.md
            else
               gh release create $NEW_TAG --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md
            fi
            
            echo "âœ… $NEW_TAG å®Œæˆ"
            
            # å¼ºåˆ¶ç¡çœ  2 ç§’ï¼Œç¡®ä¿æ–°ç‰ˆæœ¬åœ¨ GitHub ç³»ç»Ÿé‡Œçš„åˆ›å»ºæ—¶é—´æ›´æ™š
            sleep 2
            
          done < tags.txt
          
          # --- ç»ˆæä¿®æ­£ï¼šæ— è®ºå‰é¢è·³è¿‡äº†å¤šå°‘ï¼Œæœ€åéƒ½è¦æŠŠçš‡å† ç»™è¿™ä¸€ç‰ˆ ---
          if [ ! -z "$LATEST_TARGET" ]; then
            FINAL_TAG="CMFA-$LATEST_TARGET"
            echo "ğŸ‘‘ æ­£åœ¨å°† $FINAL_TAG å¼ºåˆ¶è®¾ä¸º Latest Release..."
            gh release edit "$FINAL_TAG" --make-latest || echo "âš ï¸ æ ‡è®° Latest å¤±è´¥ï¼Œå¯èƒ½æ˜¯è¯¥ç‰ˆæœ¬æœªæˆåŠŸåˆ›å»º"
          fi
          
          rm -rf download_temp tags.txt logs.txt notes.md
          echo "ğŸ æ¬è¿å®Œæˆï¼"
