name: 2. çº¯å‡€æ¬è¿ (è‰ç¨¿æµæ°´çº¿ç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  draft-assembly-sync:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: 1. å‡†å¤‡æ¸…å•
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” è·å–å…¨é‡åˆ—è¡¨..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw.txt
          
          echo "ğŸ§® Python æ™ºèƒ½æ’åº (ç¡®ä¿ä»å°åˆ°å¤§)..."
          python3 -c "
          import sys
          lines = [l.strip() for l in open('raw.txt') if l.strip()]
          def sort_key(s):
              nums = s.lstrip('v').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          lines.sort(key=sort_key)
          print('\n'.join(lines))
          " > tags.txt
          
          # é”å®š King (æœ€æ–°ç‰ˆ)
          KING_TAG=$(tail -n 1 tags.txt)
          echo "KING_TAG=$KING_TAG" >> $GITHUB_ENV
          echo "ğŸ‘‘ é”å®šçš„æ–°ç‹: $KING_TAG"

      - name: 2.ã€è¿›è´§é˜¶æ®µã€‘å…¨éƒ¨ä¸Šä¼ ä¸ºè‰ç¨¿ (Draft)
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          set +e # å…è®¸æŠ¥é”™ç»§ç»­ï¼Œä¿è¯å°½å¯èƒ½å¤šçš„æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
          
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          echo "ğŸ“¦ å¼€å§‹è¿›è´§ï¼šæ‰€æœ‰ç‰ˆæœ¬å°†å…ˆä½œä¸ºã€è‰ç¨¿ã€‘ä¸Šä¼ ..."
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # æŸ¥é‡ (å¦‚æœå·²ç»æ˜¯æ­£å¼ç‰ˆæˆ–è‰ç¨¿ï¼Œéƒ½è·³è¿‡)
            if gh release view $NEW_TAG > /dev/null 2>&1; then
               echo "â­ï¸ $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
               continue
            fi
            
            echo "ğŸ“¥ [$CURRENT/$TOTAL] ä¸‹è½½å¹¶ä¸Šä¼ è‰ç¨¿: $TAG"
            
            # å‡†å¤‡ç¬”è®°
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            if [ $? -ne 0 ]; then continue; fi
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$ORIG_DATE**\n\n---" > notes.md
            jq -r .body meta.json >> notes.md
            
            # ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null
            
            # ğŸŸ¢ æ ¸å¿ƒï¼šä¸Šä¼ ä¸º Draft (å…¬ä¼—ä¸å¯è§ï¼Œæ— æ—¶é—´æˆ³è´Ÿæ‹…)
            if [ -n "$(ls -A download_temp 2>/dev/null)" ]; then
               gh release create "$NEW_TAG" download_temp/* --title "CMFA: $TAG" -F notes.md --draft
            else
               gh release create "$NEW_TAG" --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md --draft
            fi
            
          done < tags.txt
          echo "âœ… è¿›è´§å®Œæˆï¼æ‰€æœ‰ç‰ˆæœ¬ç°å·²é™é™èººåœ¨ Draft åˆ—è¡¨ä¸­ã€‚"

      - name: 3.ã€ä¸Šæ¶é˜¶æ®µã€‘æŒ‰é¡ºåºå‘å¸ƒ (Publish)
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          set +e
          
          echo "ğŸš€ å¼€å§‹ä¸Šæ¶ï¼šæŒ‰ä¸¥æ ¼é¡ºåºå°†è‰ç¨¿è½¬ä¸ºæ­£å¼ç‰ˆ..."
          
          while read TAG; do
            NEW_TAG="CMFA-$TAG"
            
            echo "----------------------------------------"
            echo "ğŸ“¢ æ­£åœ¨å‘å¸ƒ: $NEW_TAG"
            
            # åˆ¤æ–­æ˜¯å¦ä¸º King
            EXTRA_FLAGS=""
            if [ "$TAG" == "$KING_TAG" ]; then
               # å¦‚æœæ˜¯ Kingï¼Œèµ‹äºˆ Latest çš‡å† 
               EXTRA_FLAGS="--make-latest"
               echo "ğŸ‘‘ å®ƒæ˜¯æ–°ç‹ï¼å°†æ ‡è®°ä¸º Latestã€‚"
            else
               # å¦‚æœæ˜¯æ™®é€šç‰ˆæœ¬ï¼Œæ˜¾å¼æ ‡è®°ä¸ºé Latest
               EXTRA_FLAGS="--latest=false"
            fi
            
            # ğŸŸ¢ æ ¸å¿ƒï¼šå°† Draft è½¬ä¸º Public
            # è¿™ä¸€æ­¥ç¬é—´å®Œæˆï¼Œæ­£æ˜¯è¿™ä¸€ç¬é—´å†³å®šäº† GitHub çš„æ—¶é—´æ’åº
            gh release edit "$NEW_TAG" --draft=false $EXTRA_FLAGS
            
            if [ $? -eq 0 ]; then
                echo "âœ… å‘å¸ƒæˆåŠŸ"
            else
                echo "âš ï¸ å‘å¸ƒå¤±è´¥ (å¯èƒ½æ˜¯è‰ç¨¿ä¸å­˜åœ¨)ï¼Œå°è¯•ç›´æ¥åˆ›å»º..."
                # è¡¥æ•‘æªæ–½ï¼šå¦‚æœè‰ç¨¿æ²¡æ‰¾åˆ°ï¼Œå°è¯•ç›´æ¥åˆ›å»ºä¸€ä¸ªç©ºçš„ Release å ä½
                gh release create "$NEW_TAG" --title "CMFA: $TAG (è¡¥æ•‘)" --notes "åŸç‰ˆå‘å¸ƒæ—¶é—´è§æ ‡é¢˜" $EXTRA_FLAGS
            fi
            
            # ğŸŸ¢ ç‰©ç†é—´éš”ï¼šç¡®ä¿æ—¶é—´æˆ³ä¸é‡å 
            # 2ç§’è¶³å¤Ÿäº†ï¼Œå› ä¸º API å“åº”æœ¬èº«å°±æœ‰å»¶è¿Ÿ
            echo "â³ é—´éš” 3 ç§’..."
            sleep 3
            
          done < tags.txt
          
          echo "ğŸ å®Œç¾æ”¶å®˜ï¼è¯·æŸ¥çœ‹ Releases é¡µé¢ã€‚"
          rm -rf download_temp tags.txt raw.txt meta.json notes.md
