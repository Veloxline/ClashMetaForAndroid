name: 2. 纯净搬运 (真实时间复刻版)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  real-time-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 必须有权限修改时间
    steps:
      - name: 初始化
        uses: actions/checkout@v4

      - name: 1. 获取列表与仓库信息
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          # 1. 动态获取当前仓库路径 (用于 API 调用)
          # 格式如: Veloxline/ClashMetaForAndroid
          MY_REPO=$(gh repo view --json owner,name -q ".owner.login + \"/\" + .name")
          echo "REPO_PATH=$MY_REPO" >> $GITHUB_ENV
          echo "📍 当前仓库: $MY_REPO"
          
          echo "🔍 获取原始列表..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw.txt
          
          # 2. Python 排序 (确保处理顺序是从旧到新)
          python3 -c "
          import sys
          lines = [l.strip() for l in open('raw.txt') if l.strip()]
          def sort_key(s):
              nums = s.lstrip('v').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          lines.sort(key=sort_key)
          print('\n'.join(lines))
          " > tags.txt
          
          # 锁定 King (最新版)
          KING_TAG=$(tail -n 1 tags.txt)
          echo "KING_TAG=$KING_TAG" >> $GITHUB_ENV
          echo "👑 目标新王: $KING_TAG"

      - name: 2. 搬运并恢复时间 (核心步骤)
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          # 允许脚本遇到错误继续跑 (确保所有版本都被处理)
          set +e
          
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            echo "----------------------------------------"
            echo "🚀 [$CURRENT/$TOTAL] 处理: $TAG"
            
            # 1. 抓取原版时间 (ORIG_DATE)
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            if [ $? -ne 0 ]; then echo "⚠️ 跳过无效版本"; continue; fi
            
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            echo "📅 目标时间: $ORIG_DATE"
            
            # 准备日志
            jq -r .body meta.json > notes.md
            
            # 2. 决定是否为 Latest
            LATEST_FLAG="--latest=false"
            if [ "$TAG" == "$KING_TAG" ]; then
               LATEST_FLAG="--latest" # 正确的参数是 --latest
               echo "👑 标记为 Latest"
            fi
            
            # 3. 下载与创建
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null
            
            # 创建 Release (此时时间是“现在”)
            if [ -n "$(ls -A download_temp 2>/dev/null)" ]; then
               gh release create "$NEW_TAG" download_temp/* --title "CMFA: $TAG" -F notes.md $LATEST_FLAG
            else
               gh release create "$NEW_TAG" --title "CMFA: $TAG (无附件)" -F notes.md $LATEST_FLAG
            fi
            
            # 🟢 4. 关键：强制等待 5 秒，让 GitHub 数据库入库
            # 如果不等，下面的 API 查找会报 404
            echo "⏳ 等待数据同步..."
            sleep 5
            
            # 🟢 5. 查找 Release ID (带重试机制)
            RELEASE_ID=""
            for i in {1..5}; do
               # 使用 API 获取 ID
               RELEASE_ID=$(gh api "repos/$REPO_PATH/releases/tags/$NEW_TAG" --jq .id 2>/dev/null)
               
               if [ -n "$RELEASE_ID" ]; then
                  echo "🔍 获取到 ID: $RELEASE_ID"
                  break
               fi
               echo "⚠️ 未找到 ID，重试 ($i/5)..."
               sleep 2
            done
            
            # 🟢 6. 修改时间 (Time Travel)
            if [ -n "$RELEASE_ID" ]; then
               echo "🔧 正在将时间穿越回 $ORIG_DATE ..."
               gh api --method PATCH "repos/$REPO_PATH/releases/$RELEASE_ID" -f published_at="$ORIG_DATE"
               if [ $? -eq 0 ]; then
                  echo "✅ 时间修正成功！"
               else
                  echo "❌ 时间修正失败 (API错误)"
               fi
            else
               echo "❌ 严重错误: 无法获取 ID，跳过时间修正。"
            fi
            
          done < tags.txt
          
          rm -rf download_temp tags.txt raw.txt meta.json notes.md
          echo "🏁 任务结束！请检查 Releases 页面。"
