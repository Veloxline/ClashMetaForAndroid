name: 2. çº¯å‡€æ¬è¿ (å…¨é‡æ£€ç´¢ä¿®å¤ç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  list-match-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»æœ‰æƒé™ä¿®æ”¹ Release
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: 1. å‡†å¤‡æ¸…å•
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          # è·å–å½“å‰ä»“åº“ owner/repo
          MY_REPO=$(gh repo view --json owner,name -q ".owner.login + \"/\" + .name")
          echo "REPO_PATH=$MY_REPO" >> $GITHUB_ENV
          echo "ğŸ“ å½“å‰ä»“åº“: $MY_REPO"
          
          echo "ğŸ” è·å–å…¨é‡åˆ—è¡¨..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw.txt
          
          echo "ğŸ§® Python æ’åº..."
          python3 -c "
          import sys
          lines = [l.strip() for l in open('raw.txt') if l.strip()]
          def sort_key(s):
              nums = s.lstrip('v').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          lines.sort(key=sort_key)
          print('\n'.join(lines))
          " > tags.txt
          
          # é”å®š King
          KING_TAG=$(tail -n 1 tags.txt)
          echo "KING_TAG=$KING_TAG" >> $GITHUB_ENV
          echo "ğŸ‘‘ ç›®æ ‡æ–°ç‹: $KING_TAG"

      - name: 2.ã€è¿›è´§ã€‘ä¸Šä¼ æ‰€æœ‰è‰ç¨¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          set +e
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          echo "ğŸ“¦ å¼€å§‹ä¸Šä¼ è‰ç¨¿..."
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # æŸ¥é‡
            if gh release view $NEW_TAG > /dev/null 2>&1; then
               echo "â­ï¸ $NEW_TAG å·²å­˜åœ¨"
               continue
            fi
            
            echo "ğŸ“¥ [$CURRENT/$TOTAL] ä¸Šä¼ è‰ç¨¿: $TAG"
            
            # æŠ“å–å…ƒæ•°æ®
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            if [ $? -ne 0 ]; then continue; fi
            
            # ä¿å­˜åŸå§‹æ—¶é—´åˆ°æ–‡ä»¶
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            echo "$ORIG_DATE" > "date_$TAG.txt"
            
            jq -r .body meta.json > notes.md
            
            # ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null
            
            # ä¸Šä¼ ä¸º Draft (æ³¨æ„ï¼šæ­¤æ—¶æ²¡æœ‰ Tagï¼ŒGitHub ä¼šåˆ†é…ä¸€ä¸ª untagged-xxxx)
            if [ -n "$(ls -A download_temp 2>/dev/null)" ]; then
               gh release create "$NEW_TAG" download_temp/* --title "CMFA: $TAG" -F notes.md --draft
            else
               gh release create "$NEW_TAG" --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md --draft
            fi
            
          done < tags.txt
          
          echo "âœ… è‰ç¨¿ä¸Šä¼ å®Œæ¯•ã€‚ä¼‘æ¯ 5 ç§’..."
          sleep 5

      - name: 3.ã€å‘å¸ƒã€‘å…¨é‡æ£€ç´¢å¹¶ä¿®æ­£
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
        run: |
          # ä½¿ç”¨ Python å¤„ç†å¤æ‚é€»è¾‘
          python3 -c "
          import os
          import subprocess
          import time
          import json
          
          repo_path = os.environ['REPO_PATH']
          king_tag = os.environ['KING_TAG']
          
          # è¯»å–ç›®æ ‡ tags
          with open('tags.txt', 'r') as f:
              target_tags = [line.strip() for line in f if line.strip()]
          
          print(f'ğŸš€ å¼€å§‹æ£€ç´¢ä¿®å¤æµç¨‹...')
          
          # ğŸŸ¢ 1. è·å–å½“å‰ä»“åº“æ‰€æœ‰ Releases (åŒ…æ‹¬ Drafts)
          # è¿™æ˜¯ä¿®å¤ 404 é”™è¯¯çš„å…³é”®ï¼æˆ‘ä»¬è¦ä¸€æ¬¡æ€§æ‹‰å–æ‰€æœ‰ ID
          print(f'ğŸ” æ‹‰å– {repo_path} çš„æ‰€æœ‰ Release...')
          try:
              cmd_list = ['gh', 'api', f'repos/{repo_path}/releases', '--paginate', '-q', '.[] | {id, tag_name}']
              output = subprocess.check_output(cmd_list).decode()
              
              # æ„å»ºæ˜ å°„å­—å…¸: {'CMFA-v2.8.0': 123456, ...}
              # æ³¨æ„ï¼šDraft çš„ tag_name å°±æ˜¯æˆ‘ä»¬åœ¨ create æ—¶æŒ‡å®šçš„ tag
              release_map = {}
              for line in output.strip().split('\n'):
                  if not line: continue
                  try:
                      item = json.loads(line)
                      if item.get('tag_name'):
                          release_map[item['tag_name']] = item['id']
                  except:
                      pass
                      
              print(f'âœ… æˆåŠŸè·å– {len(release_map)} ä¸ª Release ID')
              
          except Exception as e:
              print(f'âŒ è·å– Release åˆ—è¡¨å¤±è´¥: {e}')
              exit(1)

          # ğŸŸ¢ 2. éå†å¹¶ä¿®æ­£
          for tag in target_tags:
              new_tag = f'CMFA-{tag}'
              
              # ä»æ˜ å°„è¡¨ä¸­ç›´æ¥æŸ¥æ‰¾ IDï¼Œä¸å†è°ƒç”¨ API æŸ¥æ‰¾
              release_id = release_map.get(new_tag)
              
              if not release_id:
                  print(f'âš ï¸ æœªæ‰¾åˆ° {new_tag} çš„ ID (å¯èƒ½ä¸Šä¼ å¤±è´¥)ï¼Œè·³è¿‡')
                  continue
              
              # è¯»å–åŸå§‹æ—¶é—´
              try:
                  with open(f'date_{tag}.txt', 'r') as df:
                      orig_date = df.read().strip()
              except:
                  orig_date = None
              
              if not orig_date:
                  print(f'âš ï¸ ç¼ºå°‘æ—¶é—´æ•°æ®: {new_tag}')
                  continue

              # å†³å®š Latest
              is_latest = 'true' if tag == king_tag else 'false'
              
              print(f'ğŸ”§ ä¿®æ­£: {new_tag} (ID: {release_id}) -> {orig_date} [Latest: {is_latest}]')
              
              # å‘é€ PATCH
              try:
                  cmd_patch = [
                      'gh', 'api', 
                      '--method', 'PATCH', 
                      f'repos/{repo_path}/releases/{release_id}',
                      '-f', f'draft=false',
                      '-f', f'published_at={orig_date}',
                      '-f', f'make_latest={is_latest}'
                  ]
                  subprocess.check_call(cmd_patch, stdout=subprocess.DEVNULL)
              except Exception as e:
                  print(f'âŒ ä¿®æ­£å¤±è´¥: {e}')
                  
              time.sleep(1)
          "
          
          echo "ğŸ å®Œç¾æ”¶å®˜ï¼"
