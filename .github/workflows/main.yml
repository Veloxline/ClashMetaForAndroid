name: 2. çº¯å‡€æ¬è¿ (Pythonæ•°å­¦æ’åºç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  python-sort-sync:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: æ‰§è¡Œæ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” è·å–åˆ—è¡¨..."
          # å…ˆè·å–æ‰€æœ‰ v å¼€å¤´çš„ç‰ˆæœ¬ï¼Œæš‚å­˜åˆ°æ–‡ä»¶ä¸­
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw_tags.txt
          
          echo "ğŸ§® æ­£åœ¨ä½¿ç”¨ Python è¿›è¡Œä¸¥æ ¼æ•°å­¦æ’åº..."
          
          # --- æ ¸å¿ƒå¿…æ€æŠ€ï¼šPython æ’åº ---
          # è¿™æ®µ Python ä»£ç ä¼šæŠŠ "v2.9" å’Œ "v2.11" çœŸæ­£æŒ‰æ•°å­—å¤§å°æ’åˆ—
          # ç»“æœä¿è¯æ˜¯ï¼šv2.9 -> v2.10 -> v2.11
          python3 -c "
          import sys
          # è¯»å–æ‰€æœ‰è¡Œ
          lines = [l.strip() for l in open('raw_tags.txt') if l.strip()]
          # æ’åºå‡½æ•°ï¼šå»æ‰ 'v'ï¼ŒæŒ‰ '.' åˆ†å‰²ï¼Œè½¬æˆæ•°å­—åˆ—è¡¨è¿›è¡Œæ¯”è¾ƒ
          # ä¾‹å¦‚ v2.11.22 -> [2, 11, 22]
          lines.sort(key=lambda s: [int(u) for u in s.lstrip('v').split('.') if u.isdigit()])
          # æ‰“å°ç»“æœ
          print('\n'.join(lines))
          " > tags.txt
          
          # æ£€æŸ¥æ’åºç»“æœï¼ˆè°ƒè¯•ç”¨ï¼‰
          echo "ğŸ“Š æ’åºé¢„è§ˆ (å¤´éƒ¨-æ—§):"
          head -n 3 tags.txt
          echo "..."
          echo "ğŸ“Š æ’åºé¢„è§ˆ (å°¾éƒ¨-æ–°):"
          tail -n 3 tags.txt
          
          if [ ! -s tags.txt ]; then
             echo "âŒ åˆ—è¡¨ä¸ºç©ºï¼Œç»ˆæ­¢ã€‚"
             exit 1
          fi

          # é”å®šåˆ—è¡¨ä¸­æœ€åä¸€ä¸ªç‰ˆæœ¬ (Python æ’å®Œåºåï¼Œæœ€åä¸€ä¸ªä¸€å®šæ˜¯æœ€å¤§çš„)
          LATEST_TARGET=$(tail -n 1 tags.txt)
          echo "ğŸ¯ é”å®šçœŸÂ·æœ€æ–°ç‰ˆæœ¬: $LATEST_TARGET"
          
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # --- æŸ¥é‡ ---
            if gh release view $NEW_TAG > /dev/null 2>&1; then
              echo "[$CURRENT/$TOTAL] âœ… $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "----------------------------------------"
            echo "ğŸš€ [$CURRENT/$TOTAL] æ­£åœ¨æ¬è¿: $TAG"
            
            # 1. æŠ“å–æ—¶é—´
            RAW_DATE=$(gh release view $TAG -R $SOURCE_REPO --json publishedAt -q .publishedAt 2>/dev/null) || true
            if [ -n "$RAW_DATE" ]; then
                NICE_DATE=$(date -d "$RAW_DATE" +'%Y-%m-%d %H:%M')
            else
                NICE_DATE="Unknown"
            fi
            
            # 2. å‡†å¤‡æ—¥å¿—
            gh release view $TAG -R $SOURCE_REPO --json body -q .body > logs.txt
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            cat logs.txt >> notes.md
            
            # 3. ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null || true
            
            # 4. ä¸Šä¼  (å…ˆä¸æ ‡è®° Latest)
            if [ "$(ls -A download_temp)" ]; then
               gh release create $NEW_TAG download_temp/* --title "CMFA: $TAG" -F notes.md --latest=false
            else
               gh release create $NEW_TAG --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md --latest=false
            fi
            
            echo "âœ… $NEW_TAG å®Œæˆ"
            
            # ğŸŸ¢ å¼ºåˆ¶ç¡çœ  3 ç§’ (ç¡®ä¿ v2.11 çš„åˆ›å»ºæ—¶é—´ç¡®å®æ¯” v2.9 æ™š)
            sleep 3
            
          done < tags.txt
          
          # --- ç»ˆæä¿®æ­£ï¼šæŠŠçš‡å† æˆ´åœ¨çœŸæ­£çš„ç‹è€…å¤´ä¸Š ---
          if [ ! -z "$LATEST_TARGET" ]; then
            FINAL_TAG="CMFA-$LATEST_TARGET"
            echo "ğŸ‘‘ æ­£åœ¨å¼ºåˆ¶å°† $FINAL_TAG è®¾ä¸º Latest..."
            gh release edit "$FINAL_TAG" --make-latest || echo "âš ï¸ æ ‡è®°å¤±è´¥"
          fi
          
          rm -rf download_temp tags.txt raw_tags.txt logs.txt notes.md
          echo "ğŸ å®Œç¾æ”¶å®˜ï¼"
