name: 2. çº¯å‡€æ¬è¿ (é¢„åˆ¤åŠ å†•ç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  pre-calc-sync:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: æ‰§è¡Œæ™ºèƒ½æ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” 1. è·å–åŸå§‹åˆ—è¡¨..."
          # è·å–åˆ—è¡¨ï¼Œåªä¿ç•™ v å¼€å¤´çš„æ­£å¼ç‰ˆ
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw.txt
          
          echo "ğŸ§® 2. ä½¿ç”¨ Python è®¡ç®—é¡ºåºå’Œæœ€ç»ˆç›®æ ‡..."
          
          # --- Python è„šæœ¬ï¼šæ’åºå¹¶æ‰¾å‡º Latest ---
          # å®ƒä¼šç”Ÿæˆä¸€ä¸ª tags.txtï¼Œæœ€åä¸€è¡Œå°±æ˜¯æœ€æ–°çš„
          python3 -c "
          import sys
          
          # è¯»å–
          lines = [l.strip() for l in open('raw.txt') if l.strip()]
          
          # æ’åºé€»è¾‘ï¼šå°† v2.11.9 è½¬æ¢ä¸ºæ•°å­—åˆ—è¡¨ [2, 11, 9]
          # è¿™æ · 11 ä¸€å®šå¤§äº 9ï¼Œç»å¯¹ä¸ä¼šæ’é”™
          def sort_key(s):
              # å»æ‰ vï¼Œå»æ‰å¯èƒ½å­˜åœ¨çš„åç¼€
              nums = s.lstrip('v').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          
          lines.sort(key=sort_key)
          
          # æ‰“å°æ’åºåçš„åˆ—è¡¨
          print('\n'.join(lines))
          " > tags.txt
          
          # é”å®šåˆ—è¡¨ä¸­æœ€åä¸€ä¸ªç‰ˆæœ¬ï¼Œå®ƒå°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ King
          KING_TAG=$(tail -n 1 tags.txt)
          echo "========================================"
          echo "ğŸ¯ é”å®šç›®æ ‡ (King): $KING_TAG"
          echo "ğŸ“Š æ¬è¿é¡ºåº: å…ˆæ¬ $(head -n 1 tags.txt) -> ... -> æœ€åæ¬ $KING_TAG"
          echo "========================================"
          
          if [ -z "$KING_TAG" ]; then
             echo "âŒ åˆ—è¡¨ä¸ºç©ºï¼Œç»ˆæ­¢ï¼"
             exit 1
          fi

          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # --- æŸ¥é‡ ---
            if gh release view $NEW_TAG > /dev/null 2>&1; then
              echo "[$CURRENT/$TOTAL] âœ… $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "ğŸš€ [$CURRENT/$TOTAL] æ­£åœ¨æ¬è¿: $TAG"
            
            # 1. å‡†å¤‡æ—¥å¿—
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            NICE_DATE=$(date -d "$ORIG_DATE" +'%Y-%m-%d %H:%M')
            
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            jq -r .body meta.json >> notes.md
            
            # 2. ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null || true
            
            # 3. åˆ¤æ–­æ˜¯å¦ä¸º King (æœ€æ–°ç‰ˆ)
            # å¦‚æœæ˜¯ King -> ä½¿ç”¨ --make-latest
            # å¦‚æœä¸æ˜¯ -> ä½¿ç”¨ --latest=false
            IS_LATEST_FLAG="--latest=false"
            if [ "$TAG" == "$KING_TAG" ]; then
               echo "ğŸ‘‘ å½“å‰å¤„ç†çš„æ˜¯æœ€æ–°ç‰ˆï¼Œå‡†å¤‡åŠ å†•ï¼"
               IS_LATEST_FLAG="--make-latest"
            fi
            
            # 4. ä¸Šä¼  (æ ¹æ®ä¸Šé¢çš„åˆ¤æ–­ï¼Œè‡ªåŠ¨å¸¦ä¸Šæ­£ç¡®çš„ flag)
            # ä½¿ç”¨ check æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œé¿å…æŠ¥é”™
            if ls download_temp/* 1> /dev/null 2>&1; then
               gh release create $NEW_TAG download_temp/* --title "CMFA: $TAG" -F notes.md $IS_LATEST_FLAG
            else
               gh release create $NEW_TAG --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md $IS_LATEST_FLAG
            fi
            
            echo "âœ… $NEW_TAG å®Œæˆ"
            
            # ç¡çœ  5 ç§’ (è¾…åŠ© GitHub åˆ—è¡¨æ’åº)
            sleep 5
            
          done < tags.txt
          
          rm -rf download_temp tags.txt raw.txt meta.json notes.md
          echo "ğŸ å®Œç¾ç»“æŸï¼$KING_TAG åº”è¯¥æ˜¯ Latestã€‚"
