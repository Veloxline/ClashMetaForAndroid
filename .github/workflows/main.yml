name: 2. çº¯å‡€æ¬è¿ (æ™ºèƒ½æ­»ç£•ç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  smart-retry-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»æœ‰æƒé™ä¿®æ”¹ Release
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: æ‰§è¡Œæ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          # 1. é”å®šä»“åº“ä¿¡æ¯
          MY_REPO=$(gh repo view --json owner,name -q ".owner.login + \"/\" + .name")
          echo "ğŸ“ ç›®æ ‡ä»“åº“: $MY_REPO"
          
          mkdir -p download_temp
          
          echo "ğŸ” è·å–åŸå§‹åˆ—è¡¨..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > tags.txt
          
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # --- æŸ¥é‡ ---
            if gh release view $NEW_TAG > /dev/null 2>&1; then
              echo "[$CURRENT/$TOTAL] âœ… $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "----------------------------------------"
            echo "ğŸš€ [$CURRENT/$TOTAL] æ­£åœ¨æ¬è¿: $TAG"
            
            # 1. æŠ“å–åŸç‰ˆæ—¶é—´
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            NICE_DATE=$(date -d "$ORIG_DATE" +'%Y-%m-%d %H:%M')
            
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            jq -r .body meta.json >> notes.md
            
            # 2. ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null || true
            
            # 3. åˆ›å»ºå‘å¸ƒ
            echo "ğŸ“¤ ä¸Šä¼ å‘å¸ƒ..."
            if [ "$(ls -A download_temp)" ]; then
               gh release create $NEW_TAG download_temp/* --title "CMFA: $TAG" -F notes.md --latest=false
            else
               gh release create $NEW_TAG --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md --latest=false
            fi
            
            # ğŸŸ¢ 4. æ™ºèƒ½æ­»ç£•è·å– ID (æ ¸å¿ƒä¿®æ”¹)
            echo "ğŸ” æ­£åœ¨æŸ¥è¯¢ ID (å¯åŠ¨é‡è¯•æœºåˆ¶)..."
            RELEASE_ID=""
            
            # å¾ªç¯ 20 æ¬¡ï¼Œæ¯æ¬¡ 5 ç§’ï¼Œæ€»å…±ç»™ GitHub 100 ç§’çš„ååº”æ—¶é—´
            for i in {1..20}; do
              # å°è¯•è·å– ID
              RELEASE_ID=$(gh release view "$NEW_TAG" --json databaseId -q .databaseId 2>/dev/null || true)
              
              if [ -n "$RELEASE_ID" ]; then
                echo "ğŸ‰ æˆåŠŸè·å– ID: $RELEASE_ID (è€—æ—¶: $((i*5))ç§’å†…)"
                break
              fi
              
              echo "â³ [$i/20] æš‚æœªæŸ¥åˆ° IDï¼ŒGitHub æ•°æ®å°šæœªåŒæ­¥ï¼Œç­‰å¾… 5 ç§’..."
              sleep 5
            done
            
            # å¦‚æœæ­»ç£•äº† 100 ç§’è¿˜æ˜¯ç©ºçš„ï¼Œé‚£å°±çœŸçš„æ²¡åŠæ³•äº†
            if [ -z "$RELEASE_ID" ]; then
              echo "âŒ ä¸¥é‡é”™è¯¯ï¼šé‡è¯• 20 æ¬¡ä»æ— æ³•è·å– IDï¼Œ$NEW_TAG æ—¶é—´ä¿®æ­£å¤±è´¥ï¼"
            else
              # 5. ä¿®æ”¹æ—¶é—´
              echo "ğŸ”§ ä¿®æ­£æ—¶é—´æˆ³ -> $ORIG_DATE"
              gh api --method PATCH "/repos/$MY_REPO/releases/$RELEASE_ID" -f published_at="$ORIG_DATE"
              echo "âœ… å®Œæˆï¼"
            fi
            
          done < tags.txt
          
          # --- 6. è‡ªåŠ¨åŠ å†• ---
          echo "ğŸ‘‘ æ­£åœ¨è®¡ç®—æœ€æ–°ç‰ˆæœ¬..."
          # è·å–æ‰€æœ‰ tagsï¼Œç”¨ Python ç®—å‡ºæœ€å¤§çš„ç‰ˆæœ¬å·
          gh release list --limit 100 --json tagName -q '.[].tagName' | grep "^CMFA-v" > all_tags.txt
          
          LATEST_TAG=$(python3 -c "
          import sys
          lines = [l.strip() for l in open('all_tags.txt') if l.strip()]
          def sort_key(s):
              nums = s.replace('CMFA-v', '').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          lines.sort(key=sort_key)
          if lines: print(lines[-1])
          ")
          
          if [ ! -z "$LATEST_TAG" ]; then
             echo "ğŸ¯ é”å®šæ–°ç‹: $LATEST_TAG"
             gh release edit "$LATEST_TAG" --make-latest
          fi
          
          rm -rf download_temp tags.txt meta.json notes.md all_tags.txt
          echo "ğŸ æ‰€æœ‰ä»»åŠ¡ç»“æŸï¼"
