name: å…¨é‡æ¡£æ¡ˆé¦† (å®Œç¾æ’åºç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  archive-sorted:
    runs-on: ubuntu-latest
    steps:
      - name: 1. åˆå§‹åŒ– Git ç¯å¢ƒ
        uses: actions/checkout@v4

      - name: 2. æ‰§è¡Œå€’åºæ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” æ­£åœ¨è¿æ¥ $SOURCE_REPO ..."
          
          # ã€æ ¸å¿ƒä¿®æ”¹ 1ã€‘åœ¨æœ€ååŠ äº† | tac
          # ä½œç”¨ï¼šæŠŠåˆ—è¡¨åè½¬ (Oldest -> Newest)
          # è¿™æ ·è„šæœ¬ä¼šå…ˆåˆ›å»ºæ—§ç‰ˆï¼Œæœ€ååˆ›å»ºæ–°ç‰ˆã€‚
          # ç»“æœï¼šGitHub ä¼šè®¤ä¸ºæ–°ç‰ˆæ˜¯â€œåˆšåˆšæ›´æ–°çš„â€ï¼ŒæŠŠå®ƒæ’åœ¨æœ€ä¸Šé¢ï¼
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | tac > tags.txt
          
          # è°ƒè¯•ä¿¡æ¯
          TOTAL=$(wc -l < tags.txt)
          echo "ğŸ“Š æŠ“å–åˆ° $TOTAL ä¸ªç‰ˆæœ¬ (å·²åè½¬é¡ºåº)"
          
          if [ ! -s tags.txt ]; then
            echo "âŒ åˆ—è¡¨ä¸ºç©ºï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Tokenã€‚"
            exit 1
          fi
          
          # å¾ªç¯è®¡æ•°å™¨
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # æŸ¥é‡
            if gh release view $NEW_TAG > /dev/null 2>&1; then
              echo "[$CURRENT/$TOTAL] âœ… $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "----------------------------------------"
            echo "ğŸš€ [$CURRENT/$TOTAL] æ­£åœ¨æ¬è¿: $TAG"
            
            # æŠ“å–ä¿¡æ¯
            if ! RAW_DATE=$(gh release view $TAG -R $SOURCE_REPO --json publishedAt -q .publishedAt 2>/dev/null); then
               echo "âš ï¸ åŸç‰ˆä¿¡æ¯è¯»å–å¤±è´¥ï¼Œè·³è¿‡..."
               continue
            fi
            NICE_DATE=$(date -d "$RAW_DATE" +'%Y-%m-%d %H:%M')
            gh release view $TAG -R $SOURCE_REPO --json body -q .body > logs.txt
            
            # å†™å…¥æ—¥å¿—
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            cat logs.txt >> notes.md
            
            # ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null || true
            
            # ä¸Šä¼ 
            if [ "$(ls -A download_temp)" ]; then
               gh release create $NEW_TAG download_temp/* --title "CMFA: $TAG" -F notes.md
               echo "ğŸ‰ æˆåŠŸï¼"
            else
               gh release create $NEW_TAG --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md
               echo "âš ï¸ æ— é™„ä»¶ç‰ˆæœ¬å½’æ¡£ã€‚"
            fi
            
            # ç¨å¾®ç¡1ç§’ï¼Œç¡®ä¿ GitHub æœåŠ¡å™¨è®°å½•çš„æ—¶é—´æˆ³æœ‰æ˜æ˜¾é—´éš”
            sleep 1
            
            rm -f notes.md logs.txt
            
          done < tags.txt
          
          rm -rf download_temp tags.txt
          echo "ğŸ å®Œç¾æ’åºæ¬è¿å®Œæˆï¼"
