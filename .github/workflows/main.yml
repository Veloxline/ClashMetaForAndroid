name: å…¨é‡æ¡£æ¡ˆé¦† (CMFAå‘½åç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  archive-cmfa:
    runs-on: ubuntu-latest
    steps:
      - name: 1. åˆå§‹åŒ– Git ç¯å¢ƒ
        uses: actions/checkout@v4

      - name: 2. æ‰§è¡Œå…¨é‡æ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” æ­£åœ¨è·å–æœ€è¿‘ 100 ä¸ªç‰ˆæœ¬åˆ—è¡¨..."
          gh release list -R $SOURCE_REPO --limit 100 | awk '{print $1}' > tags.txt
          
          while read TAG; do
            # ğŸŸ¢ ä¿®æ”¹ç‚¹ï¼šå‰ç¼€æ”¹ä¸º CMFA-
            NEW_TAG="CMFA-$TAG"
            
            # --- 1. æŸ¥é‡ ---
            if gh release view $NEW_TAG > /dev/null 2>&1; then
              echo "âœ… [å·²å­˜æ¡£] $NEW_TAG è·³è¿‡ã€‚"
              continue
            fi
            
            echo "----------------------------------------"
            echo "ğŸš€ æ­£åœ¨å¤„ç†: $TAG"
            
            # --- 2. æŠ“å–å…ƒæ•°æ® ---
            echo "ğŸ“ å°è¯•è·å–åŸç‰ˆä¿¡æ¯..."
            
            # é˜²å´©æºƒæœºåˆ¶ï¼šå¦‚æœåŸç‰ˆè¢«åˆ ï¼Œè·³è¿‡
            if ! RAW_DATE=$(gh release view $TAG -R $SOURCE_REPO --json publishedAt -q .publishedAt 2>/dev/null); then
               echo "âš ï¸ è­¦å‘Š: åŸç‰ˆ $TAG æ— æ³•è¯»å–ï¼Œè·³è¿‡ï¼"
               continue
            fi
            
            # æ ¼å¼åŒ–æ—¥æœŸ
            NICE_DATE=$(date -d "$RAW_DATE" +'%Y-%m-%d %H:%M')
            
            # è·å–æ—¥å¿—
            gh release view $TAG -R $SOURCE_REPO --json body -q .body > original_log.txt
            
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            cat original_log.txt >> notes.md
            
            
            # --- 3. ä¸‹è½½èµ„æº ---
            echo "ğŸ“¥ ä¸‹è½½é™„ä»¶ä¸­..."
            rm -rf download_temp/*
            
            # å°è¯•ä¸‹è½½
            if ! gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null; then
               echo "âš ï¸ è­¦å‘Š: $TAG ä¸‹è½½å¤±è´¥æˆ–æ— é™„ä»¶..."
            fi
            
            
            # --- 4. ä¸Šä¼ å‘å¸ƒ ---
            echo "ğŸ“¤ æ­£åœ¨ä¸Šä¼ åˆ° $NEW_TAG ..."
            
            if [ "$(ls -A download_temp)" ]; then
               # ğŸŸ¢ ä¿®æ”¹ç‚¹ï¼šæ ‡é¢˜å‰ç¼€ä¹Ÿæ”¹ä¸º CMFA
               gh release create $NEW_TAG download_temp/* --title "CMFA: $TAG" -F notes.md
               echo "ğŸ‰ æˆåŠŸå½’æ¡£: $NEW_TAG"
            else
               # ğŸŸ¢ ä¿®æ”¹ç‚¹ï¼šæ ‡é¢˜å‰ç¼€ä¹Ÿæ”¹ä¸º CMFA
               gh release create $NEW_TAG --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md
               echo "âš ï¸ å½’æ¡£äº†æ— é™„ä»¶ç‰ˆæœ¬: $NEW_TAG"
            fi
            
            # æ¸…ç†
            rm -f notes.md original_log.txt
            
          done < tags.txt
          
          rm -rf download_temp tags.txt
          echo "ğŸ æ‰€æœ‰ä»»åŠ¡ç»“æŸï¼"
