name: 2. çº¯å‡€æ¬è¿ (ç²¾å‡†åŠ å†•ç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  crown-sync:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: æ‰§è¡Œæ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” è·å–åŸå§‹åˆ—è¡¨..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw.txt
          
          echo "ğŸ§® æ­£åœ¨è¿›è¡Œ Python ä¸¥æ ¼æ’åº (ä»å°åˆ°å¤§)..."
          
          # --- Python æ’åºï¼šç¡®ä¿ v2.9 åœ¨å‰ï¼Œv2.11 åœ¨å ---
          python3 -c "
          import sys
          lines = [l.strip() for l in open('raw.txt') if l.strip()]
          def sort_key(s):
              nums = s.lstrip('v').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          lines.sort(key=sort_key)
          print('\n'.join(lines))
          " > tags.txt
          
          # éªŒè¯æ’åº
          echo "========================================"
          echo "ğŸ“Š æ¬è¿è®¡åˆ’ (æœ€åä¸€è¡Œå¿…é¡»æ˜¯ v2.11.x):"
          echo "â¡ï¸ æœ€åä¸€è¡Œ: $(tail -n 1 tags.txt)"
          echo "========================================"
          
          if [ ! -s tags.txt ]; then
             echo "âŒ åˆ—è¡¨ä¸ºç©ºï¼"
             exit 1
          fi

          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          LAST_TAG=""  # ç”¨äºè®°ä½æœ€åä¸€ä¸ªç‰ˆæœ¬
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            LAST_TAG="$NEW_TAG"  # å®æ—¶æ›´æ–°ï¼Œå¾ªç¯ç»“æŸæ—¶å®ƒå°±æ˜¯æœ€æ–°çš„é‚£ä¸ª
            
            # --- æŸ¥é‡ ---
            if gh release view $NEW_TAG > /dev/null 2>&1; then
              echo "[$CURRENT/$TOTAL] âœ… $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "ğŸš€ [$CURRENT/$TOTAL] æ­£åœ¨æ¬è¿: $TAG"
            
            # 1. æŠ“å–æ—¥å¿—
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            NICE_DATE=$(date -d "$ORIG_DATE" +'%Y-%m-%d %H:%M')
            
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            jq -r .body meta.json >> notes.md
            
            # 2. ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null || true
            
            # 3. ä¸Šä¼  (ç»Ÿä¸€ä¸è®¾ Latest)
            if [ "$(ls -A download_temp)" ]; then
               gh release create $NEW_TAG download_temp/* --title "CMFA: $TAG" -F notes.md --latest=false
            else
               gh release create $NEW_TAG --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md --latest=false
            fi
            
            echo "âœ… $NEW_TAG å®Œæˆ"
            
            # ç¡çœ  5 ç§’ï¼Œæ‹‰å¼€æ—¶é—´å·®è·
            sleep 5
            
          done < tags.txt
          
          # --- ğŸŸ¢ ç»ˆæä¿®æ­£ï¼šä¸å†é—® GitHubï¼Œç›´æ¥åŠ å†•åˆšæ‰å¤„ç†çš„æœ€åä¸€ä¸ª ---
          echo "----------------------------------------"
          if [ ! -z "$LAST_TAG" ]; then
             echo "ğŸ‘‘ è„šæœ¬è®°å¿†ç¡®è®¤ï¼ŒçœŸæ­£çš„æœ€æ–°ç‰ˆæ˜¯: $LAST_TAG"
             echo "âš¡ æ­£åœ¨å¼ºåˆ¶åŠ å†•..."
             
             # å¼ºåˆ¶æ ‡è®°ä¸º Latest
             gh release edit "$LAST_TAG" --make-latest
             
             echo "ğŸ‰ åŠ å†•æˆåŠŸï¼$LAST_TAG ç°åœ¨æ˜¯ Latest Releaseã€‚"
          else
             echo "âš ï¸ å¼‚å¸¸ï¼šæœªèƒ½è®°å½•åˆ°ä»»ä½•ç‰ˆæœ¬ã€‚"
          fi
          
          rm -rf download_temp tags.txt raw.txt meta.json notes.md
          echo "ğŸ ä»»åŠ¡ç»“æŸï¼"
