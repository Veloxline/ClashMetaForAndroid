name: 2. çº¯å‡€æ¬è¿ (æ—¶å…‰å€’æµä¿®æ­£ç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  time-travel-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write # éœ€è¦å†™å…¥æƒé™æ¥ä¿®æ”¹ Release æ—¶é—´
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: æ‰§è¡Œæ¬è¿å¹¶ç¯¡æ”¹æ—¶é—´
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          # è·å–å½“å‰ä»“åº“çš„èº«ä»½ (ä¾‹å¦‚ User/Repo)
          MY_REPO=$(gh repo view --json owner,name -q ".owner.login + \"/\" + .name")
          echo "ğŸ“ å½“å‰ä»“åº“: $MY_REPO"
          
          mkdir -p download_temp
          
          echo "ğŸ” è·å–åˆ—è¡¨ (é¡ºåºå·²ç»ä¸é‡è¦äº†ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šå¼ºåˆ¶ä¿®æ­£æ—¶é—´)..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > tags.txt
          
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # --- æŸ¥é‡ ---
            if gh release view $NEW_TAG > /dev/null 2>&1; then
              echo "[$CURRENT/$TOTAL] âœ… $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "ğŸš€ [$CURRENT/$TOTAL] æ­£åœ¨æ¬è¿: $TAG"
            
            # 1. æŠ“å–åŸç‰ˆç²¾ç¡®æ—¶é—´ (ISO 8601 æ ¼å¼)
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            
            # å‡†å¤‡æ—¥å¿—
            NICE_DATE=$(date -d "$ORIG_DATE" +'%Y-%m-%d %H:%M')
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            jq -r .body meta.json >> notes.md
            
            # 2. ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null || true
            
            # 3. åˆ›å»ºå‘å¸ƒ (æ­¤æ—¶æ—¶é—´æ˜¯â€œç°åœ¨â€ï¼Œé¡ºåºå¯èƒ½æ˜¯ä¹±çš„)
            if [ "$(ls -A download_temp)" ]; then
               gh release create $NEW_TAG download_temp/* --title "CMFA: $TAG" -F notes.md --latest=false
            else
               gh release create $NEW_TAG --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md --latest=false
            fi
            
            # ğŸŸ¢ 4. æ ¸å¿ƒå¿…æ€æŠ€ï¼šä½¿ç”¨ API å¼ºåˆ¶æŠŠæ—¶é—´æ”¹å›åŸç‰ˆæ—¶é—´ï¼
            # è¿™æ · GitHub å°±å¿…é¡»æŒ‰ 2023ã€2024ã€2025 çš„çœŸå®æ—¶é—´è½´æ’åº
            echo "ğŸ”§ æ­£åœ¨å°†æ—¶é—´ä¿®æ­£ä¸º: $ORIG_DATE"
            gh api --method PATCH "/repos/$MY_REPO/releases/tags/$NEW_TAG" -f published_at="$ORIG_DATE"
            
            echo "âœ… $NEW_TAG å®Œæˆ (æ—¶é—´å·²ç©¿è¶Š)"
            
          done < tags.txt
          
          # --- 5. æœ€åä¿®æ­£ Latest ---
          # ç”±äºæ—¶é—´å·²ç»ä¿®æ­£ï¼ŒGitHub å…¶å®ä¼šè‡ªåŠ¨è¯†åˆ«æœ€æ–°çš„ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯å¼ºåˆ¶æ ‡è®°ä¸€ä¸‹æœ€æ™šçš„é‚£ä¸ª
          LATEST_TAG=$(gh release list --limit 1 --exclude-drafts --exclude-pre-releases --json tagName -q '.[0].tagName')
          if [ ! -z "$LATEST_TAG" ]; then
             echo "ğŸ‘‘ è‡ªåŠ¨æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæ˜¯ $LATEST_TAGï¼Œæ­£åœ¨åŠ å†•..."
             gh release edit "$LATEST_TAG" --make-latest || true
          fi
          
          rm -rf download_temp tags.txt meta.json notes.md
          echo "ğŸ å®Œç¾æ”¶å®˜ï¼"
