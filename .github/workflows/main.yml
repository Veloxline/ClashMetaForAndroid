name: 2. çº¯å‡€æ¬è¿ (å¼ºåˆ¶é€†åºç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  force-flip-sync:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: 1. è·å–å¹¶é”å®šé¡ºåº
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” è·å–åŸå§‹åˆ—è¡¨..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw.txt
          
          # ç®€å•çš„å­—ç¬¦æ’åº (é»˜è®¤ v2.11 ä¼šæ’åœ¨ v2.9 å‰é¢ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸æƒ³è¦çš„)
          # ä½†æˆ‘ä»¬é©¬ä¸Šå°±ä¼šä¿®æ­£å®ƒ
          sort raw.txt > tags.txt
          
          # --- ğŸŸ¢ æ ¸å¿ƒä¿é™©ä¸ï¼šæ£€æŸ¥é¡ºåºå¹¶å¼ºåˆ¶ç¿»è½¬ ---
          FIRST_LINE=$(head -n 1 tags.txt)
          echo "ğŸ§ æ£€æµ‹åˆ°åˆ—è¡¨ç¬¬ä¸€è¡Œæ˜¯: $FIRST_LINE"
          
          # å¦‚æœç¬¬ä¸€è¡ŒåŒ…å« "v2.11" (æ–°ç‰ˆ)ï¼Œè¯´æ˜åˆ—è¡¨æ˜¯ [æ–° -> æ—§]
          # æˆ‘ä»¬éœ€è¦ [æ—§ -> æ–°]ï¼Œæ‰€ä»¥å¿…é¡»ç¿»è½¬ï¼
          if [[ "$FIRST_LINE" == *"v2.11"* ]]; then
             echo "âš ï¸ å‘ç°é¡ºåºåäº† (æ–°ç‰ˆåœ¨å‰)ï¼æ­£åœ¨æ‰§è¡Œå¼ºåˆ¶ç¿»è½¬..."
             # tac å‘½ä»¤ç”¨äºå°†æ–‡ä»¶å€’åº (ä»æœ€åä¸€è¡Œè¯»åˆ°ç¬¬ä¸€è¡Œ)
             tac tags.txt > fixed_tags.txt
             mv fixed_tags.txt tags.txt
             echo "âœ… ç¿»è½¬å®Œæˆã€‚"
          else
             echo "âœ… é¡ºåºçœ‹èµ·æ¥æ˜¯æ­£ç¡®çš„ (æ—§ç‰ˆåœ¨å‰)ã€‚"
          fi
          
          echo "========================================"
          echo "ğŸ“Š æœ€ç»ˆæ‰§è¡Œè®¡åˆ’ (å¿…é¡»æ˜¯ v2.9 åœ¨å‰ï¼Œv2.11 åœ¨æœ€å):"
          echo "â¡ï¸ ç¬¬ä¸€æ­¥å¤„ç†: $(head -n 1 tags.txt)"
          echo "..."
          echo "â¡ï¸ æœ€åä¸€æ­¥å¤„ç†: $(tail -n 1 tags.txt)"
          echo "========================================"
          
          # é”å®šæœ€åä¸€è¡Œä½œä¸º King
          KING_TAG=$(tail -n 1 tags.txt)
          echo "KING_TAG=$KING_TAG" >> $GITHUB_ENV

      - name: 2. æ‰§è¡Œæœ‰åºæ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          set +e
          
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            echo "ğŸš€ [$CURRENT/$TOTAL] å¤„ç†: $TAG"
            
            # 1. æŠ“å–ä¿¡æ¯
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            if [ $? -ne 0 ]; then continue; fi
            
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            NICE_DATE=$(date -d "$ORIG_DATE" +'%Y-%m-%d %H:%M')
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            jq -r .body meta.json >> notes.md
            
            # 2. åˆ¤æ–­æ˜¯å¦æœ€æ–°
            # åªæœ‰æœ€åä¸€æ­¥å¤„ç† King æ—¶ï¼Œæ‰ç»™ --make-latest
            LATEST_FLAG="--latest=false"
            if [ "$TAG" == "$KING_TAG" ]; then
               LATEST_FLAG="--make-latest"
               echo "ğŸ‘‘ è¿™æ˜¯æœ€åä¸€æ­¥ï¼ŒåŠ å†•æœ€æ–°ç‰ˆï¼"
            fi
            
            # 3. ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null
            
            # 4. ä¸Šä¼ 
            # ä¿®å¤äº†æ–‡ä»¶æ£€æµ‹é€»è¾‘ï¼Œç¡®ä¿ä¸æŠ¥é”™
            if [ -n "$(ls -A download_temp 2>/dev/null)" ]; then
               gh release create "$NEW_TAG" download_temp/* --title "CMFA: $TAG" -F notes.md $LATEST_FLAG
            else
               gh release create "$NEW_TAG" --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md $LATEST_FLAG
            fi
            
            # ğŸŸ¢ 5. å¼ºåˆ¶ç¡çœ  3 ç§’
            # ç¡®ä¿ v2.11 çš„åˆ›å»ºæ—¶é—´æ¯” v2.9 æ™š 3 ç§’ä»¥ä¸Š
            # è¿™æ˜¯ GitHub æ­£ç¡®æ’åºçš„ç‰©ç†åŸºç¡€
            sleep 3
            
          done < tags.txt
          
          rm -rf download_temp tags.txt raw.txt meta.json notes.md
          echo "ğŸ ä»»åŠ¡ç»“æŸï¼"
