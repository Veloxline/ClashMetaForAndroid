name: 2. çº¯å‡€æ¬è¿ (åŸå­ä¿®å¤ç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  atomic-restore-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»æœ‰æƒé™ä¿®æ”¹ Release
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: 1. å‡†å¤‡æ¸…å•ä¸ç¯å¢ƒ
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          # è·å–å½“å‰ä»“åº“ owner/repo
          MY_REPO=$(gh repo view --json owner,name -q ".owner.login + \"/\" + .name")
          echo "REPO_PATH=$MY_REPO" >> $GITHUB_ENV
          echo "ğŸ“ å½“å‰ä»“åº“: $MY_REPO"
          
          echo "ğŸ” è·å–å…¨é‡åˆ—è¡¨..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw.txt
          
          echo "ğŸ§® Python æ’åº..."
          python3 -c "
          import sys
          lines = [l.strip() for l in open('raw.txt') if l.strip()]
          def sort_key(s):
              nums = s.lstrip('v').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          lines.sort(key=sort_key)
          print('\n'.join(lines))
          " > tags.txt
          
          # é”å®š King
          KING_TAG=$(tail -n 1 tags.txt)
          echo "KING_TAG=$KING_TAG" >> $GITHUB_ENV
          echo "ğŸ‘‘ ç›®æ ‡æ–°ç‹: $KING_TAG"

      - name: 2.ã€è¿›è´§ã€‘ä¸Šä¼ æ‰€æœ‰è‰ç¨¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          set +e
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          echo "ğŸ“¦ å¼€å§‹ä¸Šä¼ è‰ç¨¿..."
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # æŸ¥é‡
            if gh release view $NEW_TAG > /dev/null 2>&1; then
               echo "â­ï¸ $NEW_TAG å·²å­˜åœ¨"
               continue
            fi
            
            echo "ğŸ“¥ [$CURRENT/$TOTAL] ä¸Šä¼ è‰ç¨¿: $TAG"
            
            # æŠ“å–å…ƒæ•°æ®
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            if [ $? -ne 0 ]; then continue; fi
            
            # ä¿å­˜åŸå§‹æ—¶é—´åˆ°æ–‡ä»¶ï¼Œä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            echo "$ORIG_DATE" > "date_$TAG.txt"
            
            jq -r .body meta.json > notes.md
            
            # ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null
            
            # ä¸Šä¼ ä¸º Draft
            if [ -n "$(ls -A download_temp 2>/dev/null)" ]; then
               gh release create "$NEW_TAG" download_temp/* --title "CMFA: $TAG" -F notes.md --draft
            else
               gh release create "$NEW_TAG" --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md --draft
            fi
            
          done < tags.txt
          
          echo "âœ… æ‰€æœ‰è‰ç¨¿ä¸Šä¼ å®Œæ¯•ã€‚ä¼‘æ¯ 10 ç§’ç­‰å¾…æ•°æ®åº“åŒæ­¥..."
          sleep 10

      - name: 3.ã€åŸå­å‘å¸ƒã€‘API å¼ºåˆ¶ä¿®æ­£
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
        run: |
          # ä½¿ç”¨ Python å¤„ç† API è¯·æ±‚ï¼Œæ¯” Shell æ›´ç¨³å®š
          python3 -c "
          import os
          import subprocess
          import time
          import json
          
          repo_path = os.environ['REPO_PATH']
          king_tag = os.environ['KING_TAG']
          
          # è¯»å– tags
          with open('tags.txt', 'r') as f:
              tags = [line.strip() for line in f if line.strip()]
          
          print(f'ğŸš€ å¼€å§‹åŸå­å‘å¸ƒæµç¨‹ï¼Œç›®æ ‡ä»“åº“: {repo_path}')
          print(f'ğŸ‘‘ King Tag: {king_tag}')
          
          for tag in tags:
              new_tag = f'CMFA-{tag}'
              
              # è¯»å–åŸå§‹æ—¶é—´
              try:
                  with open(f'date_{tag}.txt', 'r') as df:
                      orig_date = df.read().strip()
              except:
                  print(f'âš ï¸ æ— æ³•æ‰¾åˆ° {tag} çš„æ—¶é—´æ–‡ä»¶ï¼Œè·³è¿‡')
                  continue
              
              print(f'--------------------------------')
              print(f'ğŸ”§ å¤„ç†: {new_tag} (ç›®æ ‡æ—¶é—´: {orig_date})')
              
              # 1. è·å– Release ID (å¸¦é‡è¯•)
              release_id = None
              for i in range(5):
                  try:
                      cmd = ['gh', 'api', f'repos/{repo_path}/releases/tags/{new_tag}', '--jq', '.id']
                      result = subprocess.check_output(cmd).decode().strip()
                      if result:
                          release_id = result
                          break
                  except:
                      pass
                  time.sleep(2)
              
              if not release_id:
                  print(f'âŒ æ— æ³•è·å– ID: {new_tag}')
                  continue
                  
              # 2. æ„é€  API Payload
              # å†³å®šæ˜¯å¦ä¸º latest
              is_latest = 'true' if tag == king_tag else 'false'
              
              # æ ¸å¿ƒï¼šåœ¨ä¸€ä¸ªè¯·æ±‚é‡ŒåŒæ—¶æ”¹çŠ¶æ€å’Œæ”¹æ—¶é—´
              # æ³¨æ„ï¼šAPI å‚æ•° make_latest æ¥å— 'true'/'false'/'legacy'
              payload = {
                  'draft': False,
                  'published_at': orig_date,
                  'make_latest': str(is_latest).lower()
              }
              
              # 3. å‘é€ PATCH è¯·æ±‚
              try:
                  # gh api æ¥å— json å­—æ®µ
                  cmd_patch = [
                      'gh', 'api', 
                      '--method', 'PATCH', 
                      f'repos/{repo_path}/releases/{release_id}',
                      '-f', f'draft=false',
                      '-f', f'published_at={orig_date}',
                      '-f', f'make_latest={str(is_latest).lower()}'
                  ]
                  subprocess.check_call(cmd_patch, stdout=subprocess.DEVNULL)
                  print(f'âœ… åŸå­å‘å¸ƒæˆåŠŸï¼Draft->Public, Time->{orig_date}, Latest->{is_latest}')
              except Exception as e:
                  print(f'âŒ API è¯·æ±‚å¤±è´¥: {e}')
                  
              # å°é—´éš”
              time.sleep(1)
          "
          
          echo "ğŸ å®Œç¾æ”¶å®˜ï¼"
