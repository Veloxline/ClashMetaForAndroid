name: 2. çº¯å‡€æ¬è¿ (åˆ†æ®µç¡¬é—´éš”ç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  segmented-sync:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: æ‰§è¡Œåˆ†æ®µæ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          # å…è®¸æŠ¥é”™ç»§ç»­ï¼Œé˜²æ­¢ä¸ªåˆ«ç‰ˆæœ¬å¡æ­»è„šæœ¬
          set +e
          
          mkdir -p download_temp
          
          echo "ğŸ” è·å–å…¨é‡æ ‡ç­¾åˆ—è¡¨..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > all_tags.txt
          
          # ==========================================
          # ğŸŸ¢ æ ¸å¿ƒé€»è¾‘ï¼šåˆ†æ®µå¾ªç¯ (ä» 2.8 åˆ° 2.15)
          # ==========================================
          for MINOR in {8..15}; do
            PREFIX="v2.${MINOR}."
            echo "======================================================="
            echo "ğŸ¬ æ­£åœ¨å‡†å¤‡åˆ†æ®µ: ${PREFIX}x (2.${MINOR}.0 - 2.${MINOR}.99)"
            echo "======================================================="
            
            # 1. ç­›é€‰å½“å‰æ®µçš„ç‰ˆæœ¬ (ä¾‹å¦‚ v2.8.*)
            grep "^${PREFIX}" all_tags.txt > segment_raw.txt
            
            # å¦‚æœè¿™ä¸€æ®µé‡Œæ²¡æœ‰ç‰ˆæœ¬ (æ¯”å¦‚ v2.15 è¿˜æ²¡å‡º)ï¼Œç›´æ¥è·³è¿‡
            if [ ! -s segment_raw.txt ]; then
               echo "â­ï¸ æœªå‘ç° ${PREFIX}x ç³»åˆ—ç‰ˆæœ¬ï¼Œè·³è¿‡æ­¤æ®µã€‚"
               continue
            fi
            
            # 2. æ®µå†…æ’åº (Python ç¡®ä¿ v2.8.1 < v2.8.9)
            python3 -c "
          import sys
          lines = [l.strip() for l in open('segment_raw.txt') if l.strip()]
          def sort_key(s):
              nums = s.lstrip('v').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          lines.sort(key=sort_key)
          print('\n'.join(lines))
          " > segment_tags.txt
            
            COUNT=$(wc -l < segment_tags.txt)
            echo "ğŸ“Š æœ¬æ®µå…±å‘ç° $COUNT ä¸ªç‰ˆæœ¬ï¼Œå¼€å§‹æ¬è¿..."
            
            # 3. å¼€å§‹æ¬è¿å½“å‰æ®µ
            while read TAG; do
              NEW_TAG="CMFA-$TAG"
              
              # æŸ¥é‡
              if gh release view $NEW_TAG > /dev/null 2>&1; then
                 echo "â­ï¸ $NEW_TAG å·²å­˜åœ¨"
                 continue
              fi
              
              echo "ğŸš€ æ¬è¿: $TAG"
              
              # æŠ“å–ä¿¡æ¯
              gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
              if [ $? -ne 0 ]; then continue; fi
              
              # ç”Ÿæˆ Note
              ORIG_DATE=$(jq -r .publishedAt meta.json)
              NICE_DATE=$(date -d "$ORIG_DATE" +'%Y-%m-%d %H:%M')
              echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
              jq -r .body meta.json >> notes.md
              
              # ä¸‹è½½
              rm -rf download_temp/*
              gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null
              
              # ä¸Šä¼  (å…¨éƒ¨è®¾ä¸ºé Latestï¼Œæœ€åå†ç»Ÿä¸€åŠ å†•)
              if [ -n "$(ls -A download_temp 2>/dev/null)" ]; then
                 gh release create "$NEW_TAG" download_temp/* --title "CMFA: $TAG" -F notes.md --latest=false
              else
                 gh release create "$NEW_TAG" --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md --latest=false
              fi
              
              # æ®µå†…å¾®å°é—´éš” (2ç§’)
              sleep 2
              
            done < segment_tags.txt
            
            echo "âœ… åˆ†æ®µ ${PREFIX}x å¤„ç†å®Œæ¯•ã€‚"
            
            # ==========================================
            # ğŸŸ¢ ç‰©ç†ç¡¬é—´éš”ï¼šå¼ºåˆ¶ä¼‘æ¯ 10 åˆ†é’Ÿ (600ç§’)
            # åªæœ‰å½“ä¸æ˜¯æœ€åä¸€ä¸ªå¾ªç¯æ—¶æ‰ç­‰å¾…ï¼Œé¿å…æœ€åç™½ç­‰
            # ==========================================
            if [ "$MINOR" -lt 15 ]; then
               echo "â˜• è§¦å‘åˆ†æ®µæœºåˆ¶ï¼šå¼ºåˆ¶ä¼‘çœ  10 åˆ†é’Ÿ..."
               echo "â³ ç°åœ¨çš„ 2.${MINOR}.x å°†æ¯”æœªæ¥çš„ 2.$((MINOR+1)).x æ—©å‡ºç”Ÿ 10 åˆ†é’Ÿã€‚"
               # è¿™é‡Œçš„ sleep 600 å°±æ˜¯ 10 åˆ†é’Ÿ
               # ä¸ºäº†é˜²æ­¢ Action è¶…æ—¶æˆ–æ‚¨ä¸æƒ³ç­‰å¤ªä¹…ï¼Œæ‚¨å¯ä»¥æŠŠ 600 æ”¹æˆ 300 (5åˆ†é’Ÿ)ï¼Œé€šå¸¸ä¹Ÿå¤Ÿäº†
               # æŒ‰ç…§æ‚¨çš„è¦æ±‚ï¼Œè¿™é‡Œè®¾ä¸º 600
               sleep 600
            fi
            
          done
          
          # ==========================================
          # ğŸŸ¢ ç»ˆæåŠ å†•ï¼šæ‰¾å‡ºçœŸæ­£çš„è€å¤§
          # ==========================================
          echo "----------------------------------------"
          echo "ğŸ† æ‰€æœ‰åˆ†æ®µä»»åŠ¡ç»“æŸï¼Œæ­£åœ¨å¯»æ‰¾çœŸæ­£çš„ King..."
          
          # é‡æ–°è·å–æ‰€æœ‰å·²æ¬è¿çš„æ ‡ç­¾è¿›è¡Œè®¡ç®—
          gh release list --limit 100 --json tagName -q '.[].tagName' | grep "^CMFA-v" > final_check.txt
          
          LATEST_TAG=$(python3 -c "
          import sys
          lines = [l.strip() for l in open('final_check.txt') if l.strip()]
          def sort_key(s):
              nums = s.replace('CMFA-v', '').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          lines.sort(key=sort_key)
          if lines: print(lines[-1])
          ")
          
          if [ -n "$LATEST_TAG" ]; then
             echo "ğŸ‘‘ æœ€ç»ˆç¡®è®¤æœ€æ–°ç‰ˆä¸º: $LATEST_TAG"
             echo "âš¡ æ‰§è¡ŒåŠ å†•ä»ªå¼..."
             gh release edit "$LATEST_TAG" --make-latest
             echo "ğŸ‰ å®Œç¾æ”¶å®˜ï¼"
          else
             echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•ç‰ˆæœ¬ï¼ŒåŠ å†•å¤±è´¥ã€‚"
          fi
          
          rm -rf download_temp *.txt meta.json notes.md
