name: 2. å®Œç¾æ’åº (æ…¢é€Ÿç¨³å¥ç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  mirror-slow-sort:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: æ‰§è¡Œå€’åºæ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” è·å–åˆ—è¡¨å¹¶è¿›è¡Œå€’åºå¤„ç†..."
          
          # 1. è·å–åŸå§‹åˆ—è¡¨ (æ–° -> æ—§)
          # 2. ç”¨ tac åè½¬ (æ—§ -> æ–°)
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | tac > tags.txt
          
          # --- è°ƒè¯•ï¼šæ‰“å°ä¸€ä¸‹é¡ºåºç»™æ‚¨çœ‹ ---
          echo "ğŸ“Š æ¬è¿è®¡åˆ’ (å‰3ä¸ª):"
          head -n 3 tags.txt
          echo "..."
          echo "ğŸ“Š æ¬è¿è®¡åˆ’ (æœ€å3ä¸ª - è¿™äº›åº”è¯¥æ˜¾ç¤ºåœ¨Releasesæœ€ä¸Šé¢):"
          tail -n 3 tags.txt
          echo "----------------------------------------"
          # ---------------------------
          
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # æŸ¥é‡
            if gh release view $NEW_TAG > /dev/null 2>&1; then
               echo "[$CURRENT/$TOTAL] âœ… $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
               continue
            fi

            echo "ğŸš€ [$CURRENT/$TOTAL] æ­£åœ¨æ¬è¿: $TAG"
            
            # 1. æŠ“å–ä¿¡æ¯
            if ! RAW_DATE=$(gh release view $TAG -R $SOURCE_REPO --json publishedAt -q .publishedAt 2>/dev/null); then
               echo "âš ï¸ ä¿¡æ¯è¯»å–å¤±è´¥ï¼Œè·³è¿‡..."
               continue
            fi
            NICE_DATE=$(date -d "$RAW_DATE" +'%Y-%m-%d %H:%M')
            gh release view $TAG -R $SOURCE_REPO --json body -q .body > logs.txt
            
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            cat logs.txt >> notes.md
            
            # 2. ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null || true
            
            # 3. ä¸Šä¼ 
            if [ "$(ls -A download_temp)" ]; then
               gh release create $NEW_TAG download_temp/* --title "CMFA: $TAG" -F notes.md
            else
               gh release create $NEW_TAG --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md
            fi
            
            echo "âœ… å®Œæˆ $TAG"
            
            # ğŸŸ¢ ã€å…³é”®ã€‘å¼ºåˆ¶ç¡çœ  2 ç§’
            # è¿™èƒ½ä¿è¯ä¸‹ä¸€ä¸ªç‰ˆæœ¬çš„â€œå‘å¸ƒæ—¶é—´â€ç»å¯¹æ¯”è¿™ä¸ªæ™š
            # ä»è€Œç¡®ä¿ GitHub æ’åºæ­£ç¡®
            sleep 2
            
          done < tags.txt
          
          rm -rf download_temp tags.txt logs.txt notes.md
          echo "ğŸ æ¬è¿å®Œæˆï¼å» Releases é¡µé¢çœ‹çœ‹å§ï¼Œè¿™æ¬¡ä¸€å®šå¯¹ï¼"
