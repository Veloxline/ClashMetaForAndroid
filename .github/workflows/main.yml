name: 2. 纯净搬运 (最终稳定版)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  stable-sync:
    runs-on: ubuntu-latest
    steps:
      - name: 初始化
        uses: actions/checkout@v4

      - name: 执行搬运
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "🔍 1. 获取列表..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw.txt
          
          echo "🧮 2. Python 排序 (v2.9 -> v2.11)..."
          python3 -c "
          import sys
          lines = [l.strip() for l in open('raw.txt') if l.strip()]
          # 排序: v2.11.9 -> [2, 11, 9]
          def sort_key(s):
              nums = s.lstrip('v').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          lines.sort(key=sort_key)
          print('\n'.join(lines))
          " > tags.txt
          
          # 锁定最后一行 (最新版)
          KING_TAG=$(tail -n 1 tags.txt)
          echo "🎯 锁定最新版 (King): $KING_TAG"
          
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # --- 查重 ---
            if gh release view $NEW_TAG > /dev/null 2>&1; then
              echo "[$CURRENT/$TOTAL] ✅ $NEW_TAG 已存在，跳过。"
              continue
            fi
            
            echo "🚀 [$CURRENT/$TOTAL] 正在搬运: $TAG"
            
            # 1. 准备日志
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            NICE_DATE=$(date -d "$ORIG_DATE" +'%Y-%m-%d %H:%M')
            echo -e "### 📅 原版发布时间: **$NICE_DATE**\n\n---" > notes.md
            jq -r .body meta.json >> notes.md
            
            # 2. 下载 (忽略错误)
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null || true
            
            # 3. 决定身份 (是否为 King)
            if [ "$TAG" == "$KING_TAG" ]; then
               LATEST_FLAG="--make-latest"
               echo "👑 身份确认：这是最新版！"
            else
               LATEST_FLAG="--latest=false"
            fi
            
            # 4. 上传 (关键修复：严谨判断文件是否存在)
            # 使用 ls -A 判断目录是否为空
            if [ -n "$(ls -A download_temp 2>/dev/null)" ]; then
               # 有文件 -> 带文件上传
               echo "📂 发现附件，正在上传..."
               gh release create "$NEW_TAG" download_temp/* --title "CMFA: $TAG" -F notes.md $LATEST_FLAG
            else
               # 无文件 -> 纯文本发布 (防止崩溃!)
               echo "⚠️ 无附件，仅创建 Release..."
               gh release create "$NEW_TAG" --title "CMFA: $TAG (无附件)" -F notes.md $LATEST_FLAG
            fi
            
            echo "✅ $NEW_TAG 完成"
            
            # 睡眠 3 秒
            sleep 3
            
          done < tags.txt
          
          rm -rf download_temp tags.txt raw.txt meta.json notes.md
          echo "🏁 搬运完成！"
