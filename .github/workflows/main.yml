name: 2. çº¯å‡€æ¬è¿ (åŠ¨æ€æ™ºèƒ½åˆ†æ®µç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  dynamic-segment-sync:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: 1. è·å–å¹¶æ’åºæ‰€æœ‰ç‰ˆæœ¬
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” è·å–å…¨é‡åˆ—è¡¨..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw.txt
          
          echo "ğŸ§® Python æ™ºèƒ½æ’åº..."
          # è¿™é‡Œ Python ä¼šæŠŠ v2.9 å’Œ v2.11 åŒºåˆ†å¾—æ¸…æ¸…æ¥šæ¥š
          python3 -c "
          import sys
          lines = [l.strip() for l in open('raw.txt') if l.strip()]
          def sort_key(s):
              nums = s.lstrip('v').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          lines.sort(key=sort_key)
          print('\n'.join(lines))
          " > tags.txt
          
          # é”å®š King (æœ€æ–°ç‰ˆ)
          KING_TAG=$(tail -n 1 tags.txt)
          echo "KING_TAG=$KING_TAG" >> $GITHUB_ENV
          echo "ğŸ‘‘ ç›®æ ‡æ–°ç‹: $KING_TAG"

      - name: 2. åŠ¨æ€åˆ†æ®µæ‰§è¡Œ
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          set +e # å…è®¸æŠ¥é”™ç»§ç»­
          
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          LAST_MINOR="" # ç”¨äºè®°å½•ä¸Šä¸€ä¸ªç‰ˆæœ¬å· (æ¯”å¦‚ "2.9")
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # --- æ™ºèƒ½åˆ†æ®µé€»è¾‘ ---
            # æå–å½“å‰çš„ä¸»ç‰ˆæœ¬å· (ä¾‹å¦‚ v2.9.1 -> "2.9")
            CURRENT_MINOR=$(echo $TAG | awk -F. '{print $1"."$2}')
            
            # å¦‚æœç‰ˆæœ¬å·å˜äº† (æ¯”å¦‚ä» 2.9 å˜æˆäº† 2.10)ï¼Œä¸”ä¸æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œ
            if [ -n "$LAST_MINOR" ] && [ "$CURRENT_MINOR" != "$LAST_MINOR" ]; then
                echo "========================================"
                echo "ğŸ›‘ æ£€æµ‹åˆ°ç‰ˆæœ¬è·¨è¶Š: $LAST_MINOR -> $CURRENT_MINOR"
                echo "â˜• å¼ºåˆ¶ä¼‘æ¯ 3 åˆ†é’Ÿï¼Œåˆ¶é€ æ—¶é—´ç‰©ç†æ–­å±‚..."
                echo "========================================"
                sleep 180 # 3åˆ†é’Ÿè¶³å¤Ÿäº†
            fi
            
            # æ›´æ–°è®°å½•
            LAST_MINOR="$CURRENT_MINOR"
            
            # --- æ¬è¿é€»è¾‘ ---
            # æŸ¥é‡
            if gh release view $NEW_TAG > /dev/null 2>&1; then
               echo "â­ï¸ $NEW_TAG å·²å­˜åœ¨"
               continue
            fi
            
            echo "ğŸš€ [$CURRENT/$TOTAL] å¤„ç†: $TAG"
            
            # æŠ“å–ä¿¡æ¯
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            if [ $? -ne 0 ]; then continue; fi
            
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$ORIG_DATE**\n\n---" > notes.md
            jq -r .body meta.json >> notes.md
            
            # ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null
            
            # ä¸Šä¼  (å…¨éƒ¨è®¾ä¸º falseï¼Œæœ€åå•ç‹¬åŠ å†• King)
            if [ -n "$(ls -A download_temp 2>/dev/null)" ]; then
               gh release create "$NEW_TAG" download_temp/* --title "CMFA: $TAG" -F notes.md --latest=false
            else
               gh release create "$NEW_TAG" --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md --latest=false
            fi
            
            # å°æ®µé—´éš”
            sleep 2
            
          done < tags.txt
          
      - name: 3. ç»ˆæåŠ å†• (The King)
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          NEW_TAG="CMFA-$KING_TAG"
          
          echo "----------------------------------------"
          echo "ğŸ‘‘ æ­£åœ¨ä¸ºæ–°ç‹åŠ å†•: $NEW_TAG"
          echo "----------------------------------------"
          
          # å¼ºåˆ¶ä¿®æ”¹ä¸º Latestï¼Œå¹¶ä¸”å¼ºåˆ¶æ ‡è®°ä¸ºã€æ­£å¼ç‰ˆã€‘(é Prerelease)
          # è¿™å¾ˆå…³é”®ï¼Œæœ‰æ—¶å€™ Prerelease å³ä½¿æ˜¯æ–°çš„ä¹Ÿä¸ä¼šç½®é¡¶
          gh release edit "$NEW_TAG" --make-latest --prerelease=false
          
          echo "ğŸ‰ å®Œç¾æ”¶å®˜ï¼è¯·å» Releases é¡µé¢æŸ¥çœ‹ã€‚"
          rm -rf download_temp tags.txt raw.txt meta.json notes.md
