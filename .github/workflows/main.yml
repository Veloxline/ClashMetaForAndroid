name: 2. çº¯å‡€æ¬è¿ (æ™ºèƒ½çº é”™ç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  smart-mirror:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: æ‰§è¡Œæ™ºèƒ½æ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” è·å–åŸå§‹ç‰ˆæœ¬åˆ—è¡¨..."
          # è·å–åˆ—è¡¨ï¼Œè¿‡æ»¤ v å¼€å¤´çš„æ­£å¼ç‰ˆ
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw.txt
          
          echo "ğŸ§  æ­£åœ¨è¿›è¡Œæ™ºèƒ½é¡ºåºæ£€æµ‹ä¸ä¿®æ­£..."
          
          # --- Python æ™ºèƒ½è„šæœ¬ ---
          python3 -c "
          import sys
          
          # 1. è¯»å–å¹¶æ¸…ç†ç©ºç™½ç¬¦
          lines = [l.strip() for l in open('raw.txt') if l.strip()]
          
          # 2. å®šä¹‰ç‰ˆæœ¬è§£æå‡½æ•° (å°† v2.11.9 -> [2, 11, 9])
          def parse_ver(v):
              clean = v.lstrip('v').split('-')[0] # å»æ‰ v å’Œåç¼€
              return [int(x) for x in clean.split('.') if x.isdigit()]
          
          # 3. å¼ºåˆ¶ä»å°åˆ°å¤§æ’åº (Old -> New)
          # ä¸ç®¡è¾“å…¥æ˜¯ä»€ä¹ˆé¡ºåºï¼Œè¿™é‡Œç»Ÿä¸€é‡æ–°æ’ä¸€é
          lines.sort(key=parse_ver)
          
          # 4. æœ€ç»ˆæ£€æŸ¥ (åŒé‡ä¿é™©)
          if lines:
              first = lines[0]  #åº”è¯¥æ˜¯æ—§çš„ (2.9)
              last = lines[-1]  #åº”è¯¥æ˜¯æ–°çš„ (2.11)
              # å¦‚æœæ’åºå¤±è´¥å¯¼è‡´ 2.11 åœ¨å‰é¢ï¼Œè¿™é‡Œå¯ä»¥æ‰“å°è­¦å‘Š(é€šå¸¸ sort ä¸ä¼šé”™)
              sys.stderr.write(f'DEBUG: List starts with {first}, ends with {last}\n')
          
          # 5. è¾“å‡ºæœ€ç»ˆåˆ—è¡¨
          print('\n'.join(lines))
          " > tags.txt
          
          # --- ğŸš¨ å…³é”®éªŒè¯ï¼šè¯·åœ¨è¿è¡Œæ—¥å¿—ä¸­çœ‹è¿™ä¸€æ®µ ---
          echo "========================================"
          echo "ğŸ“Š æœ€ç»ˆæ‰§è¡Œé¡ºåº (å¿…é¡»æ˜¯ v2.9 åœ¨å‰ï¼Œv2.11 åœ¨å):"
          echo "â¡ï¸ ç¬¬ä¸€æ­¥æ¬è¿: $(head -n 1 tags.txt)"
          echo "..."
          echo "â¡ï¸ æœ€åä¸€æ­¥æ¬è¿: $(tail -n 1 tags.txt)"
          echo "========================================"
          
          if [ ! -s tags.txt ]; then
             echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬åˆ—è¡¨ä¸ºç©ºï¼"
             exit 1
          fi

          # é”å®šæœ€åä¸€ä¸ªç‰ˆæœ¬ (æœ€æ–°ç‰ˆ)
          LATEST_TARGET=$(tail -n 1 tags.txt)
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # --- æŸ¥é‡ ---
            if gh release view $NEW_TAG > /dev/null 2>&1; then
              echo "[$CURRENT/$TOTAL] âœ… $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "ğŸš€ [$CURRENT/$TOTAL] æ­£åœ¨æ¬è¿: $TAG"
            
            # 1. æŠ“å–æ—¥å¿—
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            RAW_DATE=$(jq -r .publishedAt meta.json)
            NICE_DATE=$(date -d "$RAW_DATE" +'%Y-%m-%d %H:%M')
            
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            jq -r .body meta.json >> notes.md
            
            # 2. ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null || true
            
            # 3. ä¸Šä¼  (å…ˆä¸è®¾ Latest)
            if [ "$(ls -A download_temp)" ]; then
               gh release create $NEW_TAG download_temp/* --title "CMFA: $TAG" -F notes.md --latest=false
            else
               gh release create $NEW_TAG --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md --latest=false
            fi
            
            echo "âœ… $NEW_TAG å®Œæˆ"
            
            # ğŸŸ¢ ç¡çœ  3 ç§’ (ç¡®ä¿ v2.11 æ˜¯æœ€ååˆ›å»ºçš„)
            sleep 3
            
          done < tags.txt
          
          # --- ç»ˆæä¿®æ­£ï¼šæŠŠçš‡å† ç»™æœ€åå¤„ç†çš„é‚£ä¸ª ---
          if [ ! -z "$LATEST_TARGET" ]; then
             FINAL_TAG="CMFA-$LATEST_TARGET"
             echo "ğŸ‘‘ æ­£åœ¨å°†æœ€åæ¬è¿çš„ $FINAL_TAG è®¾ä¸º Latest..."
             gh release edit "$FINAL_TAG" --make-latest || true
          fi
          
          rm -rf download_temp tags.txt raw.txt meta.json notes.md
          echo "ğŸ æ¬è¿å®Œæˆï¼"
