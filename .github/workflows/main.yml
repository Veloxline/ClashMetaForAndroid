name: 2. çº¯å‡€æ¬è¿ (ç‰©ç†éš”ç¦»ç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  isolation-sync:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: 1. è·å–å¹¶æ‹†åˆ†åˆ—è¡¨
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” è·å–åŸå§‹åˆ—è¡¨..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw.txt
          
          echo "ğŸ§® Python ç²¾å‡†æ’åº..."
          # æ’åºé€»è¾‘ï¼šå°† v2.11.9 è½¬æ¢ä¸º [2, 11, 9] è¿›è¡Œæ¯”è¾ƒ
          python3 -c "
          import sys
          lines = [l.strip() for l in open('raw.txt') if l.strip()]
          def sort_key(s):
              nums = s.lstrip('v').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          lines.sort(key=sort_key)
          print('\n'.join(lines))
          " > sorted_tags.txt
          
          # --- ç‰©ç†æ‹†åˆ† ---
          # 1. æå–æœ€åä¸€è¡Œä½œä¸º King (æœ€æ–°ç‰ˆ)
          tail -n 1 sorted_tags.txt > king.txt
          KING_TAG=$(cat king.txt)
          
          # 2. æå–é™¤äº†æœ€åä¸€è¡Œä¹‹å¤–çš„æ‰€æœ‰è¡Œä½œä¸º Commoners (æ—§ç‰ˆæœ¬)
          head -n -1 sorted_tags.txt > commoners.txt
          
          echo "========================================"
          echo "ğŸ‘‘ å”¯ä¸€çš„ç‹ (King): $KING_TAG"
          echo "ğŸ‘¥ æ—§ç‰ˆæœ¬æ•°é‡: $(wc -l < commoners.txt)"
          echo "========================================"

      - name: 2. æ‰¹é‡å¤„ç†æ—§ç‰ˆæœ¬ (å¼ºåˆ¶é Latest)
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          # å…³é—­é”™è¯¯ä¸­æ–­ï¼Œç¡®ä¿æŒç»­æ‰§è¡Œ
          set +e
          
          TOTAL=$(wc -l < commoners.txt)
          CURRENT=0
          
          echo "ğŸš€ å¼€å§‹å¤„ç†æ—§ç‰ˆæœ¬ (Commoners)..."
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # æŸ¥é‡
            gh release view $NEW_TAG > /dev/null 2>&1
            if [ $? -eq 0 ]; then
              echo "[$CURRENT/$TOTAL] â­ï¸ $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "Processing [$CURRENT/$TOTAL]: $TAG"
            
            # å‡†å¤‡æ—¥å¿—
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            if [ $? -ne 0 ]; then echo "âš ï¸ è·å–ä¿¡æ¯å¤±è´¥ï¼Œè·³è¿‡"; continue; fi
            
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            NICE_DATE=$(date -d "$ORIG_DATE" +'%Y-%m-%d %H:%M')
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            jq -r .body meta.json >> notes.md
            
            # ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null
            
            # ğŸ“¤ ä¸Šä¼  (æ ¸å¿ƒï¼šå¼ºåˆ¶ --latest=false)
            echo "ğŸ“¤ ä¸Šä¼ æ—§ç‰ˆæœ¬ (Force Non-Latest)..."
            
            # æ£€æµ‹æ˜¯å¦æœ‰æ–‡ä»¶ (ä¿®å¤å´©æºƒ BUG)
            if [ -n "$(ls -A download_temp 2>/dev/null)" ]; then
               gh release create "$NEW_TAG" download_temp/* --title "CMFA: $TAG" -F notes.md --latest=false
            else
               gh release create "$NEW_TAG" --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md --latest=false
            fi
            
            # ç¨å¾®ä¼‘æ¯ï¼Œè™½ç„¶ä¸é‡è¦äº†ï¼Œä½†é˜²é£æ§
            sleep 1
            
          done < commoners.txt
          echo "âœ… æ‰€æœ‰æ—§ç‰ˆæœ¬å¤„ç†å®Œæ¯•ï¼"

      - name: 3. ç‹¬å®¶åŠ å†• (å¤„ç† King)
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          KING_TAG=$(cat king.txt)
          NEW_TAG="CMFA-$KING_TAG"
          
          echo "----------------------------------------"
          echo "ğŸ‘‘ æ­£åœ¨è¿æ¥æ–°ç‹: $KING_TAG"
          echo "----------------------------------------"
          
          # å‡†å¤‡æ—¥å¿—
          gh release view $KING_TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
          ORIG_DATE=$(jq -r .publishedAt meta.json)
          NICE_DATE=$(date -d "$ORIG_DATE" +'%Y-%m-%d %H:%M')
          echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
          jq -r .body meta.json >> notes.md
          
          # ä¸‹è½½
          rm -rf download_temp/*
          gh release download $KING_TAG -R $SOURCE_REPO -D download_temp 2>/dev/null
          
          # ğŸ“¤ ä¸Šä¼  (æ ¸å¿ƒï¼šå¼ºåˆ¶ --make-latest)
          # å³ä½¿å®ƒå·²ç»å­˜åœ¨ï¼Œæˆ‘ä»¬ä¹Ÿè¦ edit å®ƒæˆä¸º latest
          
          if gh release view $NEW_TAG > /dev/null 2>&1; then
             echo "âš ï¸ $NEW_TAG å·²å­˜åœ¨ï¼Œæ­£åœ¨å¼ºåˆ¶åŠ å†•..."
             gh release edit "$NEW_TAG" --make-latest
          else
             echo "ğŸ“¤ åˆ›å»ºå¹¶åŠ å†•..."
             if [ -n "$(ls -A download_temp 2>/dev/null)" ]; then
                gh release create "$NEW_TAG" download_temp/* --title "CMFA: $KING_TAG" -F notes.md --make-latest
             else
                gh release create "$NEW_TAG" --title "CMFA: $KING_TAG (æ— é™„ä»¶)" -F notes.md --make-latest
             fi
          fi
          
          echo "ğŸ‰ å®Œç¾æ”¶å®˜ï¼$KING_TAG ç°å·²ç™»åŸºã€‚"
          rm -rf download_temp raw.txt sorted_tags.txt commoners.txt king.txt meta.json notes.md
