name: 2. çº¯å‡€æ¬è¿ (æ—¶é—´è½´å¤åˆ»ç‰ˆ)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  timeline-sync:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: æ‰§è¡Œæ—¶é—´è½´æ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” è·å–å…ƒæ•°æ® (åŒ…å«å‘å¸ƒæ—¥æœŸ)..."
          
          # 1. ç›´æ¥è·å– JSON æ•°æ® (åŒ…å« tagName å’Œ publishedAt æ—¶é—´)
          gh release list -R $SOURCE_REPO --limit 100 --json tagName,publishedAt > releases.json
          
          echo "ğŸ“… æ­£åœ¨æ ¹æ®ã€åŸç‰ˆå‘å¸ƒæ—¶é—´ã€‘è¿›è¡Œæ’åº..."
          
          # --- æ ¸å¿ƒï¼šPython æ—¶é—´æ’åº ---
          # ä¸å†çœ‹ç‰ˆæœ¬å·æ˜¯ 2.9 è¿˜æ˜¯ 2.11
          # åªçœ‹ï¼šè°çš„æ—¶é—´æ—©ï¼Œè°å°±æ’å‰é¢
          python3 -c "
          import json, sys
          from datetime import datetime
          
          # è¯»å– JSON
          with open('releases.json', 'r') as f:
              data = json.load(f)
          
          # è¿‡æ»¤æ‰é v å¼€å¤´çš„ (ä¿ç•™æ­£å¼ç‰ˆ)
          # data = [item for item in data if item['tagName'].startswith('v')]
          # å¦‚æœæ‚¨æƒ³ä¿ç•™ v å¼€å¤´çš„é€»è¾‘ï¼Œå–æ¶ˆä¸Šé¢æ³¨é‡Šã€‚ä½†æŒ‰æ—¶é—´æ’é€šå¸¸ä¸éœ€è¦è¿‡æ»¤ï¼Œä¸‹é¢é€»è¾‘æ˜¯å…¨é‡æ’åºã€‚
          # ä¸ºäº†ä¿é™©ï¼Œè¿˜æ˜¯åŠ ä¸Šè¿‡æ»¤ v å¼€å¤´ï¼Œé˜²æ­¢å¥‡æ€ªçš„ tag æ··å…¥
          data = [item for item in data if item['tagName'].startswith('v')]
          
          # æŒ‰ publishedAt å­—ç¬¦ä¸²æ’åº (ISOæ ¼å¼å¯ä»¥ç›´æ¥é€šè¿‡å­—ç¬¦ä¸²æ’åº: 2023 < 2025)
          # reverse=False (ä»å°åˆ°å¤§: æ—§ -> æ–°)
          data.sort(key=lambda x: x['publishedAt'])
          
          # è¾“å‡ºæ’åºåçš„ tag
          for item in data:
              print(item['tagName'])
          " > tags.txt
          
          # æ£€æŸ¥æ’åºç»“æœ (ç»™æ‚¨åƒå®šå¿ƒä¸¸)
          echo "----------------------------------------"
          echo "ğŸ“Š æ¬è¿é¡ºåºé¢„æ¼”:"
          echo "â¡ï¸ ç¬¬ä¸€ä¸ªæ¬ (æœ€æ—§): $(head -n 1 tags.txt)"
          echo "â¡ï¸ æœ€åä¸€ä¸ªæ¬ (æœ€æ–°): $(tail -n 1 tags.txt)"
          echo "----------------------------------------"
          
          if [ ! -s tags.txt ]; then
             echo "âŒ åˆ—è¡¨ä¸ºç©ºï¼"
             exit 1
          fi

          # é”å®šæœ€æ–°çš„é‚£ä¸ª tag
          LATEST_TARGET=$(tail -n 1 tags.txt)
          
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # --- æŸ¥é‡ ---
            if gh release view $NEW_TAG > /dev/null 2>&1; then
              echo "[$CURRENT/$TOTAL] âœ… $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "ğŸš€ [$CURRENT/$TOTAL] æ­£åœ¨æ¬è¿: $TAG"
            
            # å‡†å¤‡æ—¥å¿—
            # è¿™é‡Œè·å–æ—¶é—´å’Œæ—¥å¿—
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            
            # è§£ææ—¶é—´
            RAW_DATE=$(jq -r .publishedAt meta.json)
            NICE_DATE=$(date -d "$RAW_DATE" +'%Y-%m-%d %H:%M')
            
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$NICE_DATE**\n\n---" > notes.md
            jq -r .body meta.json >> notes.md
            
            # ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null || true
            
            # ä¸Šä¼  (æš‚æ—¶éƒ½è®¾ä¸º latest=false)
            if [ "$(ls -A download_temp)" ]; then
               gh release create $NEW_TAG download_temp/* --title "CMFA: $TAG" -F notes.md --latest=false
            else
               gh release create $NEW_TAG --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md --latest=false
            fi
            
            echo "âœ… $NEW_TAG å®Œæˆ"
            
            # ğŸŸ¢ å¼ºåˆ¶ç¡çœ  3 ç§’ (ç¡®ä¿æ—¶é—´æˆ³ä»æ—§åˆ°æ–°æ’åˆ—)
            sleep 3
            
          done < tags.txt
          
          # --- ç»ˆæä¿®æ­£ ---
          if [ ! -z "$LATEST_TARGET" ]; then
            FINAL_TAG="CMFA-$LATEST_TARGET"
            echo "ğŸ‘‘ å¼ºåˆ¶å°† $FINAL_TAG è®¾ä¸º Latest..."
            gh release edit "$FINAL_TAG" --make-latest || true
          fi
          
          rm -rf download_temp tags.txt releases.json meta.json notes.md
          echo "ğŸ æ—¶é—´è½´å¤åˆ»å®Œæˆï¼"
