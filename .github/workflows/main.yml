name: 2. çº¯å‡€æ¬è¿ (2.10+ ç‰ˆæœ¬)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  filter-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: åˆå§‹åŒ–
        uses: actions/checkout@v4

      - name: 1. è·å–å¹¶ç­›é€‰åˆ—è¡¨ (2.10+)
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          mkdir -p download_temp
          
          echo "ğŸ” è·å–å…¨é‡åˆ—è¡¨..."
          gh release list -R $SOURCE_REPO --limit 100 --json tagName -q '.[].tagName' | grep "^v" > raw.txt
          
          echo "âœ‚ï¸ æ­£åœ¨ç­›é€‰ >= v2.10.0 çš„ç‰ˆæœ¬..."
          
          # --- Python ç­›é€‰è„šæœ¬ ---
          python3 -c "
          import sys
          
          # è¯»å–
          lines = [l.strip() for l in open('raw.txt') if l.strip()]
          
          filtered = []
          for tag in lines:
              # è§£æç‰ˆæœ¬å·: v2.11.22 -> [2, 11, 22]
              # ç§»é™¤ 'v' å’Œå¯èƒ½çš„åç¼€
              clean_v = tag.lstrip('v').split('-')[0]
              try:
                  parts = [int(x) for x in clean_v.split('.') if x.isdigit()]
                  
                  # æ ¸å¿ƒè¿‡æ»¤é€»è¾‘: ä¸»ç‰ˆæœ¬>2 æˆ– (ä¸»ç‰ˆæœ¬=2 ä¸” æ¬¡ç‰ˆæœ¬>=10)
                  if len(parts) >= 2:
                      major, minor = parts[0], parts[1]
                      if major > 2 or (major == 2 and minor >= 10):
                          filtered.append(tag)
              except:
                  continue
          
          # æ’åº: ä»æ—§åˆ°æ–° (v2.10.0 -> v2.11.22)
          def sort_key(s):
              nums = s.lstrip('v').split('-')[0].split('.')
              return [int(x) for x in nums if x.isdigit()]
          
          filtered.sort(key=sort_key)
          
          # è¾“å‡º
          print('\n'.join(filtered))
          " > tags.txt
          
          # é”å®šæœ€æ–°çš„ King
          KING_TAG=$(tail -n 1 tags.txt)
          echo "KING_TAG=$KING_TAG" >> $GITHUB_ENV
          
          COUNT=$(wc -l < tags.txt)
          echo "========================================"
          echo "ğŸ“Š ç­›é€‰ç»“æœ: å…± $COUNT ä¸ªç‰ˆæœ¬"
          echo "â¡ï¸ èµ·ç‚¹: $(head -n 1 tags.txt)"
          echo "â¡ï¸ ç»ˆç‚¹ (King): $KING_TAG"
          echo "========================================"

      - name: 2. æ‰§è¡Œæ¬è¿
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          set +e
          
          TOTAL=$(wc -l < tags.txt)
          CURRENT=0
          
          while read TAG; do
            CURRENT=$((CURRENT+1))
            NEW_TAG="CMFA-$TAG"
            
            # æŸ¥é‡
            if gh release view $NEW_TAG > /dev/null 2>&1; then
               echo "â­ï¸ $NEW_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡"
               continue
            fi
            
            echo "ğŸš€ [$CURRENT/$TOTAL] å¤„ç†: $TAG"
            
            # æŠ“å–æ—¥å¿—
            gh release view $TAG -R $SOURCE_REPO --json publishedAt,body > meta.json
            if [ $? -ne 0 ]; then continue; fi
            
            # ç”Ÿæˆ Note (ä¿ç•™åŸç‰ˆæ—¶é—´æ–‡å­—ï¼Œä½†ä¸ä»¥æ­¤ä¸ºæ’åºä¾æ®)
            ORIG_DATE=$(jq -r .publishedAt meta.json)
            echo -e "### ğŸ“… åŸç‰ˆå‘å¸ƒæ—¶é—´: **$ORIG_DATE**\n\n---" > notes.md
            jq -r .body meta.json >> notes.md
            
            # ä¸‹è½½
            rm -rf download_temp/*
            gh release download $TAG -R $SOURCE_REPO -D download_temp 2>/dev/null
            
            # å†³å®š Latest çŠ¶æ€
            # å¦‚æœæ˜¯ King -> Latest=true
            # å…¶ä»– -> Latest=false
            if [ "$TAG" == "$KING_TAG" ]; then
               LATEST_FLAG="--latest"
               echo "ğŸ‘‘ å®ƒæ˜¯æœ€æ–°ç‰ˆï¼"
            else
               LATEST_FLAG="--latest=false"
            fi
            
            # ä¸Šä¼  (ç›´æ¥åˆ›å»ºï¼Œä¾èµ–è„šæœ¬çš„è¿è¡Œé¡ºåº 2.10 -> 2.11)
            # GitHub é»˜è®¤æŠŠæœ€ååˆ›å»ºçš„è§†ä¸ºæœ€æ–°ï¼Œé…åˆ --latest æ ‡è®°åŒé‡ä¿é™©
            if [ -n "$(ls -A download_temp 2>/dev/null)" ]; then
               gh release create "$NEW_TAG" download_temp/* --title "CMFA: $TAG" -F notes.md $LATEST_FLAG
            else
               gh release create "$NEW_TAG" --title "CMFA: $TAG (æ— é™„ä»¶)" -F notes.md $LATEST_FLAG
            fi
            
            # ä¼‘æ¯ 3 ç§’ï¼Œç¡®ä¿åˆ›å»ºæ—¶é—´æœ‰å…ˆå
            sleep 3
            
          done < tags.txt
          
          echo "ğŸ æ¬è¿å®Œæˆï¼"
