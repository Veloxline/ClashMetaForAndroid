name: 1. ç²¾å‡†æ¸…ç©º (JSON Delete)

on: workflow_dispatch

jobs:
  delete-json:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. æ‰§è¡Œç²¾å‡†åˆ é™¤
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
        run: |
          echo "ðŸ” æ­£åœ¨æ‰«ææ‰€æœ‰ CMFA- å¼€å¤´çš„æ ‡ç­¾..."
          
          # ã€æ ¸å¿ƒä¿®å¤ã€‘
          # ä½¿ç”¨ --json tagName ç›´æŽ¥æå–æ ‡ç­¾åï¼Œä¸å†ä¾èµ– awk è§£æžæ–‡æœ¬
          # è¿™æ ·èƒ½ 100% æ‹¿åˆ°æ­£ç¡®çš„ Tag (å¦‚ CMFA-v2.11.22)
          gh release list --limit 100 --json tagName -q '.[].tagName' | grep "^CMFA-" > delete_list.txt
          
          TOTAL=$(wc -l < delete_list.txt)
          
          if [ "$TOTAL" -eq "0" ]; then
             echo "âœ¨ ä»“åº“é‡Œæ‰¾ä¸åˆ° CMFA- å¼€å¤´çš„ç‰ˆæœ¬ï¼Œå¯èƒ½æ˜¯å·²ç»åˆ å¹²å‡€äº†ã€‚"
             exit 0
          fi
          
          echo "âš ï¸ é”å®š $TOTAL ä¸ªç›®æ ‡ï¼Œå‡†å¤‡æ‰§è¡Œé”€æ¯..."
          cat delete_list.txt
          
          while read TAG; do
            echo "ðŸ”¥ æ­£åœ¨åˆ é™¤: $TAG"
            # --cleanup-tag: åŒæ—¶åˆ é™¤ git æ ‡ç­¾
            # --yes: ä¸è¯¢é—®ç›´æŽ¥åˆ 
            gh release delete "$TAG" --cleanup-tag --yes || echo "âš ï¸ åˆ é™¤ $TAG å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
          done < delete_list.txt
          
          echo "âœ… æ‰€æœ‰æ¸…ç†ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼"
