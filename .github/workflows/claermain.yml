name: 1. æ ¸å¼¹æ¸…ç©º (Delete All)

on: workflow_dispatch

jobs:
  delete-everything:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€æŸ¥å¯†ç  (Debug)
        env:
          TEST_KEY: ${{ secrets.MY_PAT }}
        run: |
          if [ -z "$TEST_KEY" ]; then
            echo "âŒ ä¸¥é‡é”™è¯¯ï¼šå¯†ç æ˜¯ç©ºçš„ï¼"
            echo "åŽŸå› ï¼šSecrets é‡Œçš„åå­—å¯èƒ½å†™é”™äº†ï¼ˆæ¯”å¦‚å¤šäº†ç©ºæ ¼ï¼‰ï¼Œæˆ–è€…æ²¡å­˜å¯¹ä½ç½®ã€‚"
            exit 1
          else
            echo "âœ… å¯†ç æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹å¹²æ´»..."
          fi

      - name: 2. æ‰§è¡Œæ¸…ç©º
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          SOURCE_REPO: MetaCubeX/ClashMetaForAndroid
        run: |
          echo "ðŸ—‘ï¸ æ­£åœ¨æŸ¥æ‰¾æ‚¨ä»“åº“é‡Œæ‰€æœ‰ CMFA- å¼€å¤´çš„ç‰ˆæœ¬..."
          
          # åˆ—å‡ºæ‰€æœ‰ CMFA- å¼€å¤´çš„ release
          gh release list --limit 100 | grep "CMFA-" | awk '{print $1}' > delete_list.txt
          
          TOTAL=$(wc -l < delete_list.txt)
          if [ "$TOTAL" -eq "0" ]; then
             echo "âœ¨ ä»“åº“å·²ç»å¾ˆå¹²å‡€ï¼Œæ²¡æœ‰ä»€ä¹ˆå¯åˆ çš„ã€‚"
             exit 0
          fi
          
          echo "âš ï¸ å‘çŽ° $TOTAL ä¸ªæ—§ç‰ˆæœ¬ï¼Œå‡†å¤‡å…¨éƒ¨åˆ é™¤..."
          
          while read TAG; do
            echo "ðŸ”¥ æ­£åœ¨åˆ é™¤: $TAG"
            # --cleanup-tag ä¼šè¿žåŒæ ‡ç­¾ä¸€èµ·åˆ æŽ‰ï¼Œç¡®ä¿å½»åº•æ¶ˆå¤±
            gh release delete $TAG --cleanup-tag --yes || true
          done < delete_list.txt
          
          echo "âœ… å…¨éƒ¨æ¸…ç©ºå®Œæ¯•ï¼çŽ°åœ¨è¯·åŽ»è¿è¡Œã€å®Œç¾ŽæŽ’åºç‰ˆã€‘è„šæœ¬ã€‚"
